# Database Field Name Mismatch Audit Report
## Triangle Intelligence Platform - October 24, 2025

Generated by: Claude Code Field Audit Tool
Scope: Database INSERT/UPDATE operations vs. migration schema definitions
Focus: Critical tables: dev_issues, workflow_sessions, tariff_rates_cache, invoices

---

## CRITICAL FINDINGS

### 1. dev_issues TABLE - FIELD NAME MISMATCH
**Severity: HIGH** - Data Loss Risk

#### Problem
The database column is named `context_data` but the API endpoint is sending `data`.

#### Schema (Migration: 017_create_dev_issues_table.sql)
```sql
CREATE TABLE dev_issues (
  ...
  context_data JSONB,        -- ← CORRECT FIELD NAME
  ...
);
```

#### Code Mismatch (pages/api/admin/log-dev-issue.js, line 54)
```javascript
const { data: insertedIssue, error: dbError } = await supabase
  .from('dev_issues')
  .insert([
    {
      issue_type,
      severity,
      component,
      message,
      data: data || {},      // ← WRONG FIELD NAME! Should be context_data
      user_id,
      certificate_number,
      created_at: new Date().toISOString()
    }
  ])
```

#### Impact
- Any error context data passed to the `data` parameter is **silently dropped**
- The context_data column receives NULL or default value
- Admin dashboard cannot see full error context needed for debugging
- Makes troubleshooting production issues harder

#### Fix Required
```javascript
// BEFORE:
data: data || {},

// AFTER:
context_data: data || {},
```

#### Files Affected
- `D:\bacjup\triangle-simple\pages\api\admin\log-dev-issue.js` (line 54)

#### Additional logDevIssue Callers
The function is called from many places via `logDevIssue()` and `DevIssue.*()` helpers:
- `pages/api/stripe/webhook.js` (multiple calls)
- `lib/tariff/tariff-calculator.js` (line 127)
- Many other API endpoints

✅ **logDevIssue() function itself is CORRECT** - it sends the field as `data` to the endpoint, which then needs to map it to `context_data`.

---

### 2. workflow_sessions TABLE - FIELD NAME MISMATCH
**Severity: HIGH** - Data Insertion Failure

#### Problem
The database column is named `session_key` (unique identifier) but the service is trying to insert `session_id`.

#### Schema (Migration: 003_create_workflow_sessions_table.sql, line 8)
```sql
CREATE TABLE workflow_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES user_profiles(id) ON DELETE CASCADE,
  session_key TEXT UNIQUE NOT NULL,  -- ← CORRECT FIELD NAME
  ...
);
```

#### Code Mismatch (lib/services/workflow-data-capture-service.js, line 41)
```javascript
const { data, error } = await supabase
  .from('workflow_sessions')
  .insert({
    session_id: this.sessionId,    // ← WRONG FIELD NAME! Should be session_key
    user_id: userId,
    started_at: this.workflowData.started_at,
    status: 'in_progress'
  });
```

#### Impact
- The INSERT will fail because `session_id` is not a valid column
- Workflow sessions cannot be saved to database
- Users will see errors when starting workflows
- Session tracking/recovery is broken

#### Root Cause
The service code was written expecting `session_id` but the migration defines `session_key`. Appears to be a disconnect between schema design and implementation.

#### Fix Required
```javascript
// BEFORE:
session_id: this.sessionId,

// AFTER:
session_key: this.sessionId,
```

#### Files Affected
- `D:\bacjup\triangle-simple\lib\services\workflow-data-capture-service.js` (line 41)

#### Additional References
Also search for other uses of `session_id` in this service:
- Line 28: `session_id: this.sessionId` (in object)
- Line 319: `session_id: this.sessionId` (in object)
- Line 495: `session_id: this.sessionId` (in object)

These may all need updating depending on context.

---

## VERIFIED CORRECT (No Issues Found)

### tariff_rates_cache TABLE
✅ All field names match between schema and code
- `section_301`, `section_232`, `total_rate` columns exist
- `saveTariffRatesToDatabase()` in lib/tariff/tariff-calculator.js correctly uses all fields (lines 614-630)
- `saveAIDataToDatabase()` also correct (lines 657-673)

### invoices TABLE  
✅ All field names match
- Stripe webhook correctly inserts/updates all fields (pages/api/stripe/webhook.js, lines 555-568)
- No naming mismatches detected

### logDevIssue() Function
✅ Function correctly sends `data` parameter to endpoint
- lib/utils/logDevIssue.js correctly calls the endpoint (line 56)
- The endpoint handler is what needs fixing (see Finding #1)

---

## SUMMARY TABLE

| Table | Field Name | Code Sends | Schema Expects | Status | Severity |
|-------|-----------|-----------|----------------|--------|----------|
| dev_issues | Context data | `data` | `context_data` | ❌ MISMATCH | HIGH |
| workflow_sessions | Session ID | `session_id` | `session_key` | ❌ MISMATCH | HIGH |
| tariff_rates_cache | Policy tariffs | Various | Matching | ✅ OK | - |
| invoices | Payment data | Various | Matching | ✅ OK | - |

---

## RECOMMENDED ACTIONS

### Priority 1: Fix Immediately
1. **dev_issues field mapping**
   - Change `data:` to `context_data:` in pages/api/admin/log-dev-issue.js
   - Test with a dev issue logging call
   - Verify admin dashboard shows context data

2. **workflow_sessions field mapping**
   - Change `session_id:` to `session_key:` in lib/services/workflow-data-capture-service.js
   - Check all 3 references (lines 28, 41, 319, 495)
   - Test workflow creation end-to-end
   - Verify sessions persist to database

### Priority 2: Code Audit
1. Search for other uses of these misnamed fields:
   ```bash
   grep -r "session_id" pages/api lib/ --include="*.js"
   grep -r "context_data\|issue_data" pages/api lib/ --include="*.js"
   ```

2. Update TypeScript definitions in lib/types/ if they exist:
   - Verify dev_issues type definition
   - Verify workflow_sessions type definition

### Priority 3: Testing
1. Unit tests for dev issue logging
2. Integration test for workflow session creation
3. Admin dashboard test to verify context data displays correctly

---

## APPENDIX: Schema References

### dev_issues TABLE (from 017_create_dev_issues_table.sql)
```sql
CREATE TABLE dev_issues (
  id UUID PRIMARY KEY,
  issue_type TEXT NOT NULL,
  severity TEXT NOT NULL,
  component TEXT NOT NULL,
  message TEXT NOT NULL,
  context_data JSONB,            -- ← STORE CONTEXT HERE
  user_id UUID,
  certificate_number TEXT,
  created_at TIMESTAMPTZ,
  resolved BOOLEAN,
  ...
);
```

### workflow_sessions TABLE (from 003_create_workflow_sessions_table.sql)
```sql
CREATE TABLE workflow_sessions (
  id UUID PRIMARY KEY,
  user_id UUID,
  session_key TEXT UNIQUE NOT NULL,  -- ← STORE SESSION ID HERE
  status TEXT,
  company_name TEXT,
  product_description TEXT,
  ...
);
```

---

## NOTES FOR DEVELOPERS

1. **Why These Mismatches Happen**
   - Schema defined in migrations, but code written independently
   - Field names can be inconsistent between design and implementation
   - No validation that INSERT/UPDATE field names match schema columns
   - Supabase JavaScript client doesn't validate column names at request time

2. **Why They're Dangerous**
   - Silent data loss: null values inserted instead of throwing errors
   - INSERT failures don't always produce clear error messages
   - Can work in development (if schema is missing) but fail in production (strict schema)
   - Makes debugging harder because the data you think you're saving isn't there

3. **Prevention Going Forward**
   - Generate TypeScript types from Supabase schema
   - Use strict type checking on all database operations
   - Validate schema column names in database operations
   - Add migration tests to verify code matches schema
