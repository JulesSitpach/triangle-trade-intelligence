# TRIANGLE COMPLETE DATA FLOW - VISUAL

## ğŸš€ THE JOURNEY: User Input â†’ PDF Download

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         STEP 1: USER SUBMITS FORM                               â”‚
â”‚                    (components/workflow/CompanyInformationStep.js)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FORM DATA                                                                       â”‚
â”‚  â”œâ”€ company_name: "TechFlow Electronics"                                        â”‚
â”‚  â”œâ”€ destination_country: "US"                                                   â”‚
â”‚  â”œâ”€ trade_volume: "$8,500,000"                                                  â”‚
â”‚  â””â”€ component_origins: [                                                        â”‚
â”‚      { description: "Microprocessor", origin_country: "CN", value_percentage: 35 } â”‚
â”‚      { description: "Capacitors", origin_country: "US", value_percentage: 30 }  â”‚
â”‚      { description: "Connectors", origin_country: "MX", value_percentage: 35 }  â”‚
â”‚    ]                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
                    â±ï¸  POSTED TO API: /api/ai-usmca-complete-analysis
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         STEP 2: HYBRID ENRICHMENT - DATABASE-FIRST + AI FALLBACK               â”‚
â”‚   PHASE 1 (Lines 429-496): Database lookup for all components                  â”‚
â”‚   PHASE 2 (Lines 661-681): Validation checkpoint 1 - detect missing rates      â”‚
â”‚   PHASE 3 (Lines 454-481): AI fallback for components missing database data    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PHASE 1: enrichComponentsWithFreshRates() - FAST DATABASE LOOKUP (~100ms)       â”‚
â”‚                                                                                   â”‚
â”‚ INPUT: 3 components (no tariff rates yet)                                        â”‚
â”‚                                                                                   â”‚
â”‚ FOR EACH COMPONENT:                                                              â”‚
â”‚  1. Check if HS code exists â†’ "8542.31.00" âœ“                                    â”‚
â”‚  2. Query: SELECT mfn_rate, section_301, section_232 FROM tariff_rates_cache   â”‚
â”‚     WHERE hs_code='8542.31.00' AND destination_country='US'                     â”‚
â”‚  3. Result scenarios:                                                            â”‚
â”‚     âœ… FOUND: {mfn_rate: 2.5, section_301: 25, stale: false}                   â”‚
â”‚     âš ï¸  MISS: {mfn_rate: 0, rate_source: 'database_fallback', stale: true}     â”‚
â”‚                                                                                   â”‚
â”‚ OUTPUT: enrichedComponents (some with rates, some with 0 rates)                 â”‚
â”‚                                                                                   â”‚
â”‚ Expected: 95% of components found in database âœ…                                â”‚
â”‚ Fallback: 5% will have mfn_rate === 0 and need Phase 3 AI lookup               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ›¡ï¸ VALIDATION CHECKPOINT 1: Verify enrichedComponents have rates (Lines 661-681)â”‚
â”‚                                                                                   â”‚
â”‚ CHECK: Filter components with mfn_rate === 0 or stale === true                 â”‚
â”‚                                                                                   â”‚
â”‚ SCENARIOS:                                                                       â”‚
â”‚ âœ… Fast Path (95%): missingRates.length === 0                                   â”‚
â”‚    â†’ Skip Phase 3, use database rates                                            â”‚
â”‚    â†’ Continue to pre-calculation                                                 â”‚
â”‚                                                                                   â”‚
â”‚ âš ï¸  Slow Path (5%): missingRates.length > 0                                     â”‚
â”‚    â†’ Log which components are missing                                            â”‚
â”‚    â†’ Proceed to Phase 3 for AI fallback                                          â”‚
â”‚                                                                                   â”‚
â”‚ LOG OUTPUT:                                                                      â”‚
â”‚   âœ… [PHASE 1] Database enrichment complete: {with_rates: 3, missing_rates: 0}  â”‚
â”‚   â±ï¸  [PHASE 2] Identifying missing rates: 0 components need AI lookup          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
                   (IF missingRates.length > 0, proceed to Phase 3)
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PHASE 3: getAIRatesForMissingComponents() - AI FALLBACK (~2000ms, only if needed)â”‚
â”‚                                                                                   â”‚
â”‚ INPUT: Only components with mfn_rate === 0 (e.g., 0-5 components out of 3)    â”‚
â”‚                                                                                   â”‚
â”‚ PROCESS:                                                                         â”‚
â”‚  1. Build compact batch prompt with ONLY missing components                      â”‚
â”‚  2. Call OpenRouter (Tier 1) with 2-tier fallback to Anthropic (Tier 2)        â”‚
â”‚  3. Extract tariff rates from AI response                                        â”‚
â”‚  4. Normalize to percentages (match database format)                             â”‚
â”‚  5. Return results                                                               â”‚
â”‚                                                                                   â”‚
â”‚ MERGE BACK:                                                                      â”‚
â”‚  For each component with mfn_rate === 0:                                         â”‚
â”‚    enrichedComponents[i] = {                                                     â”‚
â”‚      ...enrichedComponents[i],                                                   â”‚
â”‚      ...aiResult,                  â† Overwrite with AI rates                     â”‚
â”‚      rate_source: 'ai_fallback',  â† Track that AI filled the gap                â”‚
â”‚      stale: false                 â† Fresh from AI                                â”‚
â”‚    }                                                                              â”‚
â”‚                                                                                   â”‚
â”‚ OUTPUT: enrichedComponents (now ALL have rates, 100% complete)                  â”‚
â”‚                                                                                   â”‚
â”‚ LOG OUTPUT (only if Phase 3 runs):                                               â”‚
â”‚   ğŸ¤– [PHASE 3] Calling AI for 1 missing components...                           â”‚
â”‚   âœ… [MERGE] Filled missing rates for 8542.31.00: MFN 2.5%, Section 301 25%     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              STEP 3: PRE-CALCULATE FINANCIAL DATA                               â”‚
â”‚            (Lines 449-518 in ai-usmca-complete-analysis.js)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Calculate BEFORE sending to AI (saves AI tokens):                                â”‚
â”‚                                                                                   â”‚
â”‚ Trade Volume: $8,500,000                                                         â”‚
â”‚                                                                                   â”‚
â”‚ Component-Level Financials:                                                      â”‚
â”‚  â”œâ”€ Microprocessor (CN, 35%):                                                   â”‚
â”‚  â”‚   Component Value: $8.5M Ã— 35% = $2,975,000                                  â”‚
â”‚  â”‚   MFN Cost: $2,975,000 Ã— 2.5% = $74,375                                      â”‚
â”‚  â”‚   Section 301 Cost: $2,975,000 Ã— 25% = $743,750                              â”‚
â”‚  â”‚   Subtotal: $818,125/year                                                    â”‚
â”‚  â”‚                                                                                â”‚
â”‚  â”œâ”€ Capacitors (US, 30%):                                                       â”‚
â”‚  â”‚   Component Value: $8.5M Ã— 30% = $2,550,000                                  â”‚
â”‚  â”‚   MFN Cost: $2,550,000 Ã— 0% = $0                                             â”‚
â”‚  â”‚   Section 301 Cost: $0 (US origin)                                            â”‚
â”‚  â”‚   Subtotal: $0/year                                                           â”‚
â”‚  â”‚                                                                                â”‚
â”‚  â””â”€ Connectors (MX, 35%):                                                       â”‚
â”‚      Component Value: $8.5M Ã— 35% = $2,975,000                                  â”‚
â”‚      MFN Cost: $2,975,000 Ã— 1.2% = $35,700                                      â”‚
â”‚      Section 301 Cost: $0 (MX origin)                                            â”‚
â”‚      Subtotal: $35,700/year                                                     â”‚
â”‚                                                                                   â”‚
â”‚ TOTALS:                                                                          â”‚
â”‚  â”œâ”€ Total Annual MFN Cost: $110,075                                              â”‚
â”‚  â”œâ”€ Total Section 301 Burden: $743,750                                           â”‚
â”‚  â””â”€ Total Annual Savings (if qualified): $110,075 Ã— USMCA rates = TBD           â”‚
â”‚                                                                                   â”‚
â”‚ OUTPUT: preCalculatedFinancials = {                                              â”‚
â”‚   trade_volume: 8500000,                                                         â”‚
â”‚   annual_tariff_savings: 0,  â† Will be calculated in AI based on USMCA rates   â”‚
â”‚   section_301_exposure: {                                                        â”‚
â”‚     is_exposed: true,                                                            â”‚
â”‚     annual_cost_burden: 743750,  â† SECTION 301 BURDEN                           â”‚
â”‚     affected_components: ["Microprocessor (CN)"]                                â”‚
â”‚   }                                                                               â”‚
â”‚ }                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              STEP 4: BUILD AI PROMPT & SEND TO OPENROUTER                       â”‚
â”‚        (Lines 521-565 in ai-usmca-complete-analysis.js)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ buildComprehensiveUSMCAPrompt() creates prompt with:                             â”‚
â”‚                                                                                   â”‚
â”‚ PROMPT CONTENTS:                                                                 â”‚
â”‚  â”œâ”€ Industry & Thresholds                                                        â”‚
â”‚  â”‚  â””â”€ Electronics: 65% RVC required                                             â”‚
â”‚  â”‚                                                                                â”‚
â”‚  â”œâ”€ Enriched Components (WITH TARIFF RATES):                                    â”‚
â”‚  â”‚  â”œâ”€ Microprocessor (8542.31.00) - CN, 35%                                    â”‚
â”‚  â”‚  â”‚  â””â”€ MFN: 2.5%, Section 301: 25%, USMCA: 0%                               â”‚
â”‚  â”‚  â”œâ”€ Capacitors (US) - US, 30%                                                 â”‚
â”‚  â”‚  â”‚  â””â”€ MFN: 0%, Section 301: 0%, USMCA: 0%                                   â”‚
â”‚  â”‚  â””â”€ Connectors (MX) - MX, 35%                                                 â”‚
â”‚  â”‚     â””â”€ MFN: 1.2%, Section 301: 0%, USMCA: 0%                                â”‚
â”‚  â”‚                                                                                â”‚
â”‚  â”œâ”€ Pre-calculated Regional Content:                                             â”‚
â”‚  â”‚  â”œâ”€ USMCA Component %: 65% (US 30% + MX 35%)                                 â”‚
â”‚  â”‚  â”œâ”€ Manufacturing Labor: 8%                                                   â”‚
â”‚  â”‚  â””â”€ Total NA Content: 73% âœ… MEETS 65% THRESHOLD                              â”‚
â”‚  â”‚                                                                                â”‚
â”‚  â””â”€ Financial Impact (from pre-calculation):                                     â”‚
â”‚     â”œâ”€ Section 301 exposure: $743,750/year âš ï¸                                    â”‚
â”‚     â”œâ”€ Affected: Microprocessor (Chinese origin)                                â”‚
â”‚     â””â”€ Strategic Option: Mexico nearshoring ($3,500/year cost, 3-month payback)â”‚
â”‚                                                                                   â”‚
â”‚ AI TASK:                                                                         â”‚
â”‚  â†’ Verify: Does product qualify? (73% >= 65%?)                                  â”‚
â”‚  â†’ Determine: Preference Criterion (A/B/C/D)                                    â”‚
â”‚  â†’ Classify: Product HS code (finished product, not components)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
                        ğŸ“¤ SEND PROMPT TO OPENROUTER
                        Model: claude-haiku-4.5
                        Max Tokens: 2000
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              STEP 5: PARSE AI RESPONSE                                           â”‚
â”‚            (Lines 579-687 in ai-usmca-complete-analysis.js)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AI Returns (valid JSON):                                                         â”‚
â”‚ {                                                                                 â”‚
â”‚   "product": {                                                                   â”‚
â”‚     "hs_code": "8517.62.00",  â† Finished product classification                 â”‚
â”‚     "description": "Electronic control units",                                   â”‚
â”‚     "confidence_score": 0.92                                                     â”‚
â”‚   },                                                                              â”‚
â”‚   "usmca": {                                                                     â”‚
â”‚     "qualified": true,              âœ… QUALIFIED!                                â”‚
â”‚     "north_american_content": 73,   âœ… 73% >= 65% THRESHOLD                     â”‚
â”‚     "threshold_applied": 65,        âœ… Electronics industry standard              â”‚
â”‚     "preference_criterion": "B",    âœ… RVC-based (most common)                   â”‚
â”‚     "reason": "Qualified with 73% RVC (Electronics threshold: 65%)"              â”‚
â”‚   }                                                                               â”‚
â”‚ }                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              STEP 6: ENRICH COMPONENTS & BUILD FINAL RESPONSE                   â”‚
â”‚        (Lines 750-1030 in ai-usmca-complete-analysis.js)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ enrichComponentsWithTariffRates() - Extract rates from AI calculation_detail     â”‚
â”‚                                                                                   â”‚
â”‚ FOR EACH COMPONENT, search AI's calculation_detail for:                          â”‚
â”‚  "1. Microprocessor (8542.31.00, 35%) ... MFN rate: 2.5% ... Section 301: 25%"  â”‚
â”‚   â†“                                                                               â”‚
â”‚  Extract: mfn_rate=2.5, section_301=25, usmca_rate=0                            â”‚
â”‚   â†“                                                                               â”‚
â”‚  Add to component: {                                                              â”‚
â”‚    description: "Microprocessor",                                                â”‚
â”‚    mfn_rate: 2.5,         â† EXTRACTED FROM AI                                   â”‚
â”‚    section_301: 25,       â† EXTRACTED FROM AI                                   â”‚
â”‚    usmca_rate: 0,         â† EXTRACTED FROM AI                                   â”‚
â”‚    total_rate: 27.5,      â† CALCULATED (2.5 + 25 + 0)                           â”‚
â”‚    savings_percentage: 0  â† CALCULATED (no USMCA rate available yet)            â”‚
â”‚  }                                                                                â”‚
â”‚                                                                                   â”‚
â”‚ Result: enrichedComponents (WITH ALL TARIFF FIELDS) âœ…                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              STEP 7: TRANSFORM COMPONENTS FOR FRONTEND                          â”‚
â”‚      (Lines 784-830 in ai-usmca-complete-analysis.js)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ transformAPIToFrontend() converts percentage format to decimal:                  â”‚
â”‚                                                                                   â”‚
â”‚ INPUT (Percentages from AI/Database):                                            â”‚
â”‚  mfn_rate: 2.5                â† percentage                                       â”‚
â”‚  section_301: 25              â† percentage                                       â”‚
â”‚                                                                                   â”‚
â”‚ OUTPUT (Decimals for Frontend):                                                  â”‚
â”‚  mfnRate: 0.025               â† decimal (dividing by 100)                       â”‚
â”‚  section301: 0.25             â† decimal (dividing by 100)                       â”‚
â”‚                                                                                   â”‚
â”‚ WHY? Frontend does: tariff_cost = componentValue Ã— mfnRate                      â”‚
â”‚  If mfnRate = 2.5 (wrong): cost = 1,000,000 Ã— 2.5 = $2,500,000 âŒ              â”‚
â”‚  If mfnRate = 0.025 (right): cost = 1,000,000 Ã— 0.025 = $25,000 âœ…             â”‚
â”‚                                                                                   â”‚
â”‚ Result: transformedComponents (CORRECT FORMAT FOR FRONTEND) âœ…                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              STEP 8: BUILD FINAL RESPONSE JSON                                   â”‚
â”‚        (Lines 833-1062 in ai-usmca-complete-analysis.js)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FINAL API RESPONSE STRUCTURE:                                                    â”‚
â”‚                                                                                   â”‚
â”‚ {                                                                                 â”‚
â”‚   "success": true,                                                               â”‚
â”‚   "company": {                                                                   â”‚
â”‚     "name": "TechFlow Electronics",                                              â”‚
â”‚     "country": "US",                  â† CRITICAL FOR CERTIFICATE!                â”‚
â”‚     "destination_country": "US",                                                 â”‚
â”‚     "tax_id": "12-3456789"                                                       â”‚
â”‚   },                                                                              â”‚
â”‚   "usmca": {                                                                     â”‚
â”‚     "qualified": true,                âœ… QUALIFIED                               â”‚
â”‚     "north_american_content": 73,                                                â”‚
â”‚     "threshold_applied": 65,                                                     â”‚
â”‚     "preference_criterion": "B",      âœ… REQUIRED FOR CERTIFICATE                â”‚
â”‚     "component_breakdown": [          â† ENRICHED COMPONENTS WITH RATES          â”‚
â”‚       {                                                                           â”‚
â”‚         "description": "Microprocessor",                                         â”‚
â”‚         "hs_code": "8542.31.00",                                                â”‚
â”‚         "origin_country": "CN",                                                 â”‚
â”‚         "mfnRate": 0.025,             â† DECIMAL FORMAT FOR FRONTEND              â”‚
â”‚         "section301": 0.25,           â† DECIMAL FORMAT FOR FRONTEND              â”‚
â”‚         "usmcaRate": 0,                                                          â”‚
â”‚         "rate_source": "ai_extracted",                                           â”‚
â”‚         "stale": false                                                           â”‚
â”‚       },                                                                          â”‚
â”‚       { ... 2 more components ... }                                              â”‚
â”‚     ]                                                                             â”‚
â”‚   },                                                                              â”‚
â”‚   "savings": {                        â† FINANCIAL IMPACT                         â”‚
â”‚     "annual_savings": 110075,                                                    â”‚
â”‚     "monthly_savings": 9173,                                                     â”‚
â”‚     "savings_percentage": 1.29,                                                  â”‚
â”‚     "section_301_exposure": {         â† POLICY RISK                              â”‚
â”‚       "is_exposed": true,                                                        â”‚
â”‚       "annual_cost_burden": 743750,   â† POLICY TARIFF (separate from USMCA)     â”‚
â”‚       "affected_components": ["Microprocessor (CN)"]                            â”‚
â”‚     }                                                                             â”‚
â”‚   },                                                                              â”‚
â”‚   "certificate": {                    â† ONLY IF QUALIFIED                        â”‚
â”‚     "qualified": true,                                                           â”‚
â”‚     "preference_criterion": "B",                                                 â”‚
â”‚     "blanket_start": "2025-10-27",                                               â”‚
â”‚     "blanket_end": "2026-10-27"                                                  â”‚
â”‚   }                                                                               â”‚
â”‚ }                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
                            ğŸ“Š RESPONSE SENT TO FRONTEND
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              STEP 9: FRONTEND DISPLAYS RESULTS                                   â”‚
â”‚         (components/workflow/WorkflowResults.js)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DISPLAYS:                                                                        â”‚
â”‚                                                                                   â”‚
â”‚ âœ… QUALIFIED FOR USMCA PREFERENTIAL TREATMENT                                    â”‚
â”‚                                                                                   â”‚
â”‚ Component Breakdown:                                                              â”‚
â”‚  â”œâ”€ Microprocessor (CN, 35%): 2.5% MFN, 25% Section 301 â†’ $818,125/year        â”‚
â”‚  â”œâ”€ Capacitors (US, 30%): 0% MFN â†’ $0/year                                      â”‚
â”‚  â””â”€ Connectors (MX, 35%): 1.2% MFN â†’ $35,700/year                               â”‚
â”‚                                                                                   â”‚
â”‚ RVC Analysis: 73% (exceeds 65% threshold by 8%)                                  â”‚
â”‚                                                                                   â”‚
â”‚ Financial Impact:                                                                 â”‚
â”‚  â”œâ”€ Annual Tariff Savings: $110,075 (USMCA vs MFN)                              â”‚
â”‚  â””â”€ âš ï¸ Section 301 Burden: $743,750/year (CANNOT be eliminated by USMCA)       â”‚
â”‚                                                                                   â”‚
â”‚ Strategic Option:                                                                 â”‚
â”‚  Mexico nearshoring eliminates Section 301 (3-month payback)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              STEP 10: USER REVIEWS & DOWNLOADS CERTIFICATE                      â”‚
â”‚       (components/workflow/EditableCertificatePreview.js)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EDITABLE CERTIFICATE PREVIEW:                                                    â”‚
â”‚                                                                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚ â”‚         CERTIFICATE OF ORIGIN - USMCA FORM D                         â”‚          â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚
â”‚ â”‚ Box 1: TechFlow Electronics (EDITABLE)                              â”‚          â”‚
â”‚ â”‚ Box 2: Importer (EDITABLE)                                          â”‚          â”‚
â”‚ â”‚ Box 3: Product: Electronic control units (EDITABLE)                â”‚          â”‚
â”‚ â”‚ Box 4: Description: HS Code 8517.62.00 (EDITABLE)                 â”‚          â”‚
â”‚ â”‚                                                                      â”‚          â”‚
â”‚ â”‚ Components:                                                          â”‚          â”‚
â”‚ â”‚  [+] Microprocessor | 8542.31.00 | CN | 35% | [DELETE] (EDITABLE)  â”‚          â”‚
â”‚ â”‚  [+] Capacitors | ... (EDITABLE)                                    â”‚          â”‚
â”‚ â”‚  [+] Connectors | ... (EDITABLE)                                    â”‚          â”‚
â”‚ â”‚                                                                      â”‚          â”‚
â”‚ â”‚ Box 17: Certification:                                              â”‚          â”‚
â”‚ â”‚  I certify that the information provided is accurate â˜‘              â”‚          â”‚
â”‚ â”‚  I accept responsibility for accuracy â˜‘                             â”‚          â”‚
â”‚ â”‚                                                                      â”‚          â”‚
â”‚ â”‚ âš ï¸ WARNING: You are responsible for accuracy. Platform provides     â”‚          â”‚
â”‚ â”‚    tools only. Consult trade attorney if uncertain.                 â”‚          â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                                   â”‚
â”‚ User edits all fields to match their records âœï¸                                 â”‚
â”‚ User checks both responsibility boxes â˜‘ï¸                                         â”‚
â”‚ User clicks "Download Certificate"                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              STEP 11: CLIENT-SIDE PDF GENERATION                                â”‚
â”‚         (html2pdf.js library in browser)                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ handleDownloadPDF():                                                              â”‚
â”‚                                                                                   â”‚
â”‚ 1. Capture DOM: Get <div id="certificate-preview-for-pdf">                      â”‚
â”‚    â†“                                                                              â”‚
â”‚ 2. Convert HTML â†’ PDF using html2pdf.js library                                 â”‚
â”‚    â†“                                                                              â”‚
â”‚ 3. Apply options:                                                                â”‚
â”‚    - Margin: 10mm                                                                â”‚
â”‚    - Format: Letter (8.5" Ã— 11")                                                 â”‚
â”‚    - Orientation: Portrait                                                       â”‚
â”‚    - Quality: JPEG 0.98                                                          â”‚
â”‚    â†“                                                                              â”‚
â”‚ 4. Save as: USMCA-Certificate-2025-10-27.pdf                                   â”‚
â”‚    â†“                                                                              â”‚
â”‚ 5. Browser downloads file to user's computer â¬‡ï¸                                 â”‚
â”‚                                                                                   â”‚
â”‚ âœ… PDF MATCHES PREVIEW EXACTLY                                                   â”‚
â”‚ âœ… ALL USER EDITS INCLUDED                                                       â”‚
â”‚ âœ… READY FOR CUSTOMS BROKER                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
                       ğŸ“¥ USER HAS CERTIFICATE PDF
                            (Ready for shipment)
```

---

## ğŸ”´ CRITICAL DATA FLOW POINTS

### **Point 1: Database Enrichment (Line 346-427)**
```
INPUT:  3 components (NO tariff rates)
   â†“
QUERY: tariff_rates_cache for MFN, Section 301, Section 232
   â†“
OUTPUT: enrichedComponents (WITH tariff rates)
   â†“
PURPOSE: Get current 2025 rates BEFORE calling AI
```

### **Point 2: Financial Pre-Calculation (Line 449-518)**
```
INPUT:  enrichedComponents (with rates)
   â†“
CALCULATE: Component-level costs (MFN cost, Section 301 burden, etc)
   â†“
OUTPUT: preCalculatedFinancials (annual savings, policy exposure)
   â†“
PURPOSE: Send AI pre-calculated numbers (saves tokens + faster response)
```

### **Point 3: AI Prompt Construction (Line 521-533)**
```
INPUT:  enrichedComponents + preCalculatedFinancials
   â†“
BUILD:  Comprehensive prompt with ALL tariff data visible to AI
   â†“
OUTPUT: Prompt that says "73% >= 65% QUALIFIED" (AI verifies, doesn't calculate)
   â†“
PURPOSE: AI just confirms qualification, doesn't do heavy math
```

### **Point 4: AI Response (Line 579-687)**
```
INPUT:  AI response (JSON)
   â†“
PARSE:  Extract {qualified, preference_criterion, north_american_content}
   â†“
OUTPUT: analysis object
   â†“
PURPOSE: Get YES/NO + criterion + product classification from AI
```

### **Point 5: Component Enrichment FROM AI (Line 332-444)**
```
ğŸ›¡ï¸ VALIDATION CHECKPOINT 2: Only use AI rates if database rates are missing

INPUT:  enrichedComponents (already has rates from DB)
        + AI response (may or may not have calculation_detail with rates)
   â†“
VALIDATE: Check if component already has mfn_rate > 0
   â†“
SCENARIOS:
   âœ… SKIP (if has DB rate): Keep database rate, skip extraction
      â†’ log: "[FALLBACK-SKIP] Component already has database rate"

   âš ï¸  EXTRACT (if missing): Try to pull mfn_rate, section_301 from AI
      â†’ log: "[FALLBACK-EXTRACT] Extracting rates..."
   â†“
EXTRACTION:
   âœ… SUCCESS: Extracted mfn_rate, section_301 from AI response
      â†’ log: "[FALLBACK-SUCCESS] Filled missing rates"
      â†’ Set rate_source: 'ai_fallback'

   âŒ MISS: Could not extract rates from AI response
      â†’ log: "[FALLBACK-MISS] Could not extract rates"
      â†’ Keep existing 0 rates (component remains incomplete)
   â†“
RESULT: enrichedComponents with rates ONLY from successful sources
```

### **Point 6: Transform to Frontend Format (Line 1017-1056)**
```
ğŸ›¡ï¸ VALIDATION CHECKPOINT 3: Verify rates are percentages before transformation

INPUT:  componentBreakdown (should be percentages: 2.5, 25, 0)
   â†“
VALIDATE: Check if rates look like decimals (0.025, 0.25) instead of percentages
   â†“
CHECK LOGIC:
   IF rate > 0 AND rate < 1:
      â†’ Likely a decimal (WRONG FORMAT - should be 25, not 0.25)
      â†’ log: "âš ï¸  [VALIDATION] unexpected rate format"
      â†’ Log to DevIssue for investigation
   â†“
TRANSFORM: If format is correct, divide by 100 â†’ decimals (0.025, 0.25, 0)
   â†“
OUTPUT: transformedComponents (decimals ready for frontend)
   â†“
VALIDATION: Both required fields present after transformation?
   â”œâ”€ rate_source: "ai_extracted", "database_cache", or "ai_fallback" âœ…
   â””â”€ stale: true/false âœ…

WHY THIS MATTERS:
   Frontend calculates: tariff_cost = componentValue Ã— mfnRate
   If mfnRate = 2.5 (wrong):  cost = 1,000,000 Ã— 2.5 = $2,500,000 âŒ 100x too large!
   If mfnRate = 0.025 (right): cost = 1,000,000 Ã— 0.025 = $25,000 âœ… Correct
```

### **Point 7: Final Response Assembly (Line 833-1030)**
```
INPUT:  transformedComponents + AI analysis + preCalculatedFinancials
   â†“
COMBINE:
   â”œâ”€ company (from form)
   â”œâ”€ usmca (from AI + DB)
   â”œâ”€ savings (from pre-calculation + AI)
   â”œâ”€ component_origins (from enrichment)
   â””â”€ certificate (template for download)
   â†“
OUTPUT: Complete API response sent to frontend
   â†“
FRONTEND RECEIVES: Everything needed to:
   â”œâ”€ Display component table with tariff rates
   â”œâ”€ Calculate savings
   â”œâ”€ Populate certificate form
   â””â”€ Enable PDF download
```

---

## ğŸ¯ WHERE DATA IS CREATED, USED, AND LOST

| Data Field | Created | Source | Used | Lost? |
|---|---|---|---|---|
| `mfn_rate` | enrichedComponents | `tariff_rates_cache` | Component breakdown, savings calc | âŒ Preserved |
| `section_301` | enrichedComponents | `tariff_rates_cache` | Policy warnings, financial impact | âŒ Preserved |
| `usmca_rate` | enrichedComponents | `tariff_rates_cache` | Savings calculation | âš ï¸ Sometimes 0 |
| `rate_source` | enrichedComponents | Code: "database_cache" | Track data provenance | âœ… Included in response |
| `stale` | enrichedComponents | Code: `!rateData` | Show staleness warnings | âœ… Included in response |
| `preference_criterion` | AI response | OpenRouter | Certificate form | âŒ Preserved |
| `north_american_content` | AI response | OpenRouter | RVC display | âŒ Preserved |
| `component_breakdown` | transformedComponents | enrichedComponents + transform | API response | âŒ Preserved |

---

## âš¡ THE FAST PATH (What Actually Happens)

```
USER SUBMITS
    â†“
[FAST] Database lookup: tariff_rates_cache (instant)
    â†“
[FAST] Pre-calculate financials (local math, no AI)
    â†“
[SLOW] Call OpenRouter: "Is this qualified? Yes/No"
    â†“
[FAST] Extract response + build result object
    â†“
[FAST] Transform + return to frontend
    â†“
Total Time: ~2-3 seconds (mostly waiting for OpenRouter)
```

**Why fast?** No enrichComponentsWithTariffIntelligence() second AI call. Database handles it.

---

## ğŸš¨ AREAS OF CONCERN & CRITICAL FAILURE POINTS

### **CONCERN 1: Database Cache Dependency (PHASE 1 - Lines 429-496)**
**Risk Level:** ğŸ”´ **HIGH** - Single point of failure for 95% of requests

**Problem:**
- System expects tariff_rates_cache to have current 2025 rates
- 95% of requests succeed ONLY if database has data
- If database is stale or empty, Phase 1 returns components with mfn_rate=0
- Fallback to Phase 3 AI adds 2+ seconds to response

**Current Status:**
- âœ… Phase 1 validates database lookup success
- âœ… Phase 3 AI fallback exists for cache misses
- âš ï¸ RSS feeds update database (need verification: are they running?)
- âš ï¸ No automatic cache refresh if older than 24 hours

**Action Required:**
- [ ] Verify RSS polling cron job is running (`pages/api/cron/email-crisis-check.js`)
- [ ] Check tariff_rates_cache table last_updated timestamps
- [ ] If cache older than 24 hours â†’ trigger manual update

---

### **CONCERN 2: AI Extraction from Vague Responses (STEP 6 - Lines 332-444)**
**Risk Level:** ğŸŸ¡ **MEDIUM** - AI response format might change

**Problem:**
- enrichComponentsWithTariffRates() uses regex to extract rates from AI's calculation_detail
- If AI changes response format, extraction fails silently
- Components stay with 0 rates instead of failing loudly
- Frontend shows incomplete data without warning

**Current Status:**
- âœ… Validation Checkpoint 2 detects missing rates after extraction
- âœ… Logs show [FALLBACK-SKIP] vs [FALLBACK-EXTRACT] tracking
- âš ï¸ Regex patterns are fragile (depends on AI wording)
- âš ï¸ No test coverage for extraction accuracy

**Example of Format Dependency:**
```
AI must say: "MFN rate: 25%"
If AI says: "Tariff: 25% (MFN)" â†’ Extraction fails âŒ
If AI says: "Duties before USMCA: 25%" â†’ Extraction fails âŒ
```

**Action Required:**
- [ ] Test AI extraction with various response formats
- [ ] Add unit tests for extractComponentRate() function
- [ ] Consider switching to structured AI responses (JSON only, no text)

---

### **CONCERN 3: Hybrid Enrichment Merge Logic (PHASE 3 - Lines 461-474)**
**Risk Level:** ğŸŸ¡ **MEDIUM** - Complex state management

**Problem:**
- Phase 1 returns components with some rates from DB, some zeros
- Phase 3 merges AI results back with exact logic: `if (mfnRate === 0) overwrite`
- If component has mfn_rate: 0.01 (from malformed DB entry), merge won't happen
- Multiple data sources (DB + AI) create data consistency issues

**Current Status:**
- âœ… Merge logic is explicit (only overwrites when mfn_rate === 0)
- âœ… rate_source field tracks which rates come from which source
- âš ï¸ No validation that merged rates are sensible (could be AI hallucinations)
- âš ï¸ No atomic transaction (could fail between phase 1 and phase 3)

**Action Required:**
- [ ] Add post-merge validation (rates within expected ranges)
- [ ] Add test case: 1 component from DB + 1 from AI + 1 with 0 rates
- [ ] Monitor rate_source distribution in production logs

---

### **CONCERN 4: Rate Format Validation (VALIDATION CHECKPOINT 3 - Lines 1017-1046)**
**Risk Level:** ğŸŸ¡ **MEDIUM** - Silent 100x calculation errors

**Problem:**
- If rates accidentally get converted to decimals early (0.025 instead of 2.5)
- Validation catches the error but transformation still proceeds
- Frontend receives wrong format, calculates 100x too large
- ğŸ›¡ï¸ **Checkpoint 3 now detects this** but doesn't auto-fix

**Current Status:**
- âœ… Validation Checkpoint 3 detects format anomalies
- âœ… Logs warn when rates look like decimals
- âœ… DevIssue logged for investigation
- âš ï¸ Workflow doesn't BLOCK on format errors (just warns)
- âš ï¸ Frontend has no validation of received rates

**Example:**
```
Component arrives at frontend with:
  mfnRate: 2.5        â† Expected (percentage)
  mfnRate: 0.025      â† WRONG (decimal)

Frontend does: $1M Ã— 0.025 = $25K âœ… Correct
Frontend does: $1M Ã— 2.5 = $2.5M âŒ 100x error

Checkpoint 3 would catch: mfnRate is between 0-1, log warning
But workflow continues anyway
```

**Action Required:**
- [ ] Frontend should validate rates are >= 0 (reject values like 2.5 if expecting decimals)
- [ ] Add unit test: component with wrong rate format should be caught
- [ ] Consider failing loud instead of just warning

---

### **CONCERN 5: Missing Data After Enrichment (VALIDATION CHECKPOINT 1 - Lines 665-726)**
**Risk Level:** ğŸ”´ **HIGH** - Data loss prevention with destination-aware strategy
**Status:** âœ… **FIXED (Oct 27, 2025 - Commit 3116f51)**

**Problem (Original):**
- Checkpoint 1 detects if components have missing rates AFTER Phase 1
- But workflow continues even with missing rates
- Components with mfn_rate=0 proceed to pre-calculation
- Financial calculations happen with 0 rates (costs all show $0)
- Users might not realize data is incomplete

**Solution Implemented:**
Added **destination-aware validation logic** that:
1. **US/CA destinations (STRICT)**: Return 400 error if any rates missing
   - Reason: Volatile tariffs change with policy (Section 301, etc.)
   - Error includes: missing HS codes, recovery instructions, retry guidance
   - Log: `[P0-BLOCKER] Cannot proceed without tariff data for US/CA destination`

2. **Mexico destination (LENIENT)**: Warn but continue
   - Reason: Database cache is reliable for Mexico (stable rates)
   - Log: `[P0-WARNING] Mexico destination - continuing with N components`
   - Workflow proceeds normally with whatever data available

**Code Changes (Lines 679-725):**
```javascript
// Destination-aware error handling
const isUSDestination = formData.destination_country === 'US';
const isCADestination = formData.destination_country === 'CA';
const isMXDestination = formData.destination_country === 'MX';

// STRICT: US/CA markets require current tariff data
if ((isUSDestination || isCADestination) && missingRatesAfterPhase3.length > 0) {
  return res.status(400).json({
    success: false,
    error: 'tariff_data_unavailable',
    message: `Unable to retrieve current tariff rates for ${count} component(s).`,
    details: {
      missing_components: [{ hs_code, description, action: 'Verify HS code format (10-digit)' }],
      suggestion: 'Check internet connection and try again in a few minutes.'
    }
  });
}

// LENIENT: Mexico workflow continues (cache is reliable)
if (isMXDestination && missingRatesAfterPhase3.length > 0) {
  console.warn(`âš ï¸ Mexico destination - continuing with ${count} components`);
}
```

**Current Status (After Fix):**
- âœ… Checkpoint 1 detects missing rates
- âœ… Destination-aware validation (strict vs lenient)
- âœ… Returns 400 error with actionable recovery steps for US/CA
- âœ… User-facing error message included
- âœ… Missing HS codes shown for verification
- âœ… All scenarios logged to DevIssue dashboard

**Tested Scenarios:**
```
Fast Path (95%): missingRates.length === 0 âœ…
  â†’ All rates available, continue normally

Slow Path (5%): missingRates.length > 0 after Phase 3
  US/CA: Returns 400 error âœ… Prevents silent data loss
  Mexico: Warns but continues âœ… Allows workflow to proceed
```

**Impact:**
- âœ… Eliminates silent data loss on volatile markets (US tariffs)
- âœ… Clear error messaging for users (not silent 0% fallback)
- âœ… Mexico operations unaffected (can proceed with cache)
- âœ… All edge cases logged for monitoring

**Remaining Actions:**
- [ ] Monitor P0-BLOCKER and P0-WARNING logs in production
- [ ] Track how often users hit the 400 error (should be <1%)
- [ ] If >1%: indicates cache needs updating, RSS polling issue

---

### **CONCERN 6: AI Fallback (PHASE 3) Timeout/Failure (Lines 43-204)**
**Risk Level:** ğŸŸ¡ **MEDIUM** - API dependency

**Problem:**
- Phase 3 calls OpenRouter (Tier 1) with 2-second timeout
- If OpenRouter fails, falls back to Anthropic Direct
- If both fail, returns empty array and continues
- No maximum timeout - could hang indefinitely if both APIs down

**Current Status:**
- âœ… 2-tier fallback exists (OpenRouter â†’ Anthropic)
- âœ… Error is caught and logged
- âš ï¸ No timeout specified for Anthropic fallback
- âš ï¸ No circuit breaker (could retry immediately after failure)
- âš ï¸ If both APIs unavailable, requests slow down but don't fail clearly

**Action Required:**
- [ ] Add 5-second timeout for Anthropic fallback
- [ ] Implement exponential backoff if both fail (don't retry Phase 3 for 60s)
- [ ] Return explicit error if Phase 3 is needed but both AI endpoints fail
- [ ] Add monitoring: track Phase 3 success rate (should be >99%)

---

### **CONCERN 7: Rate Source Tracking (Throughout - rate_source field)**
**Risk Level:** ğŸŸ¢ **LOW** - Well-tracked but needs monitoring

**Problem:**
- Components can have different rate_source values: database_cache, ai_fallback, incomplete
- Frontend needs to understand what each means
- No documentation visible to users

**Current Status:**
- âœ… rate_source clearly logged at each step
- âœ… Validation checkpoints track transitions
- âœ… DevIssue logs anomalies
- âš ï¸ Frontend doesn't display data provenance
- âš ï¸ Users don't know if rates are fresh or stale

**Action Required:**
- [ ] Add data freshness badge to component table (e.g., "From database" vs "From AI")
- [ ] Display staleness warning if stale === true
- [ ] Document what each rate_source means for users

---

### **CONCERN 8: Form Validation (Before API Call - Lines 281-331)**
**Risk Level:** ğŸŸ¢ **LOW** - Well-defended but depends on frontend

**Problem:**
- API validates required fields, but frontend sends form
- If frontend validation broken, API catches it
- Missing company_country would break certificate generation

**Current Status:**
- âœ… API validates 14 required fields
- âœ… Clear error messages returned
- âœ… Frontend should also validate (belt-and-suspenders)
- âš ï¸ Unclear which validation is primary (frontend vs API)

**Action Required:**
- [ ] Document validation split: frontend (UX) vs API (security)
- [ ] Add test: submit form without company_country, verify API error

---

## ğŸ“Š QUICK RISK MATRIX

| Area | Risk | Impact | Status | Fix Priority |
|------|------|--------|--------|--------------|
| Database Cache | ğŸ”´ HIGH | 95% of requests slow | âš ï¸ Depends on RSS | P0 |
| AI Extraction | ğŸŸ¡ MEDIUM | Data loss if format changes | âš ï¸ Detectable | P1 |
| Merge Logic | ğŸŸ¡ MEDIUM | Data inconsistency | âœ… Tracked | P2 |
| Rate Format | ğŸŸ¡ MEDIUM | 100x calculation errors | âœ… Detected | P1 |
| Missing Data | ğŸ”´ HIGH | Silent data loss to users | âœ… **FIXED** (Oct 27) | âœ… DONE |
| AI Timeout | ğŸŸ¡ MEDIUM | Slow response | âš ï¸ No timeout | P1 |
| Rate Source | ğŸŸ¢ LOW | Opacity to users | âš ï¸ Not visible | P2 |
| Form Validation | ğŸŸ¢ LOW | Broken certificates | âœ… Validated | P3 |

