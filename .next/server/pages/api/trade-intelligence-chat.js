"use strict";(()=>{var e={};e.id=7680,e.ids=[7680],e.modules={2885:e=>{e.exports=require("@supabase/supabase-js")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},9736:(e,t,a)=>{a.r(t),a.d(t,{config:()=>l,default:()=>u,routeModule:()=>d});var n={};a.r(n),a.d(n,{default:()=>handler});var i=a(1802),r=a(7153),s=a(6249),o=a(2885);let c=(0,o.createClient)("https://mrwitpgbcaxgnirqtavt.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY);async function handler(e,t){if("POST"!==e.method)return t.status(405).json({error:"Method not allowed"});let{question:a,sessionId:n,language:i="en"}=e.body;if(!a?.trim())return t.status(400).json({error:"Question is required"});try{console.log("\uD83E\uDDE0 Marcus Intelligence Chat:",a,"Language:",i),await trackQuestionPattern(a,n);let e=await analyzeQuestion(a.trim().toLowerCase(),i),r=await enhanceWithMarcusIntelligence(e,a,i);return t.status(200).json({success:!0,response:r.answer,followUpQuestion:r.followUp,dataSource:r.source,confidence:r.confidence,intelligenceGathered:r.intelligenceGathered})}catch(e){return console.error("Marcus chat error:",e),t.status(500).json({error:"Sorry, I encountered an error. Please try again.",success:!1})}}async function analyzeQuestion(e,t="en"){if(e.includes("hs code")||e.includes("tariff code")||e.includes("classification"))return await handleHSCodeQuestion(e,t);if(e.includes("tariff")||e.includes("duty")||e.includes("rate"))return await handleTariffQuestion(e,t);if(e.includes("route")||e.includes("shipping")||e.includes("mexico")||e.includes("canada"))return await handleRoutingQuestion(e,t);if(e.includes("alert")||e.includes("news")||e.includes("update")||e.includes("changes"))return await handleMarketAlertsQuestion(e,t);if(e.includes("companies")||e.includes("similar")||e.includes("peers")||e.includes("benchmark"))return await handlePeerQuestion(e,t);if(e.includes("success rate")||e.includes("savings")||e.includes("average"))return await handleBusinessIntelligenceQuestion(e,t);let a=e.toLowerCase();return a.includes("$")||a.includes("million")||a.includes("m ")||a.includes("import")||a.includes("annually")||a.includes("diversify")||a.includes("volume")||a.includes("china")&&(a.includes("should")||a.includes("alternative"))?await handleHighValueBusinessQuestion(e,t):await handleGeneralProductQuestion(e,t)}async function handleHSCodeQuestion(e,t="en"){let a=["electronics","smartphone","laptop","computer","phone","headphones","textiles","clothing","fabric","cotton","leather","boots","shoes","machinery","equipment","tools","automotive","parts","solar","panel","battery","inverter","controller","management","food","agriculture","medical","devices"].filter(t=>e.includes(t));if(0===a.length){let e="What product are you looking for the HS code? For example: 'What's the HS code for smartphones?' or 'leather boots classification'";return"es"===t?e="\xbfPara qu\xe9 producto buscas el c\xf3digo HS? Por ejemplo: '\xbfCu\xe1l es el c\xf3digo HS para smartphones?' o 'clasificaci\xf3n de botas de cuero'":"fr"===t&&(e="Pour quel produit cherchez-vous le code HS? Par exemple: 'Quel est le code HS pour smartphones?' ou 'classification des bottes en cuir'"),{answer:e,source:"guidance",confidence:100}}let{data:n}=await c.from("trade_flows").select("hs_code, product_description").or(a.map(e=>`product_description.ilike.%${e}%`).join(",")).limit(5);if(n&&n.length>0){let e=n[0];return{answer:`HS code ${e.hs_code} - ${e.product_description}. Found in our 597K trade flows database. Check USMCA rates for potential triangle routing savings.`,source:"trade_flows",confidence:90}}let{data:i}=await c.from("comtrade_reference").select("hs_code, product_description, mfn_tariff_rate, usmca_tariff_rate").or(a.map(e=>`product_description.ilike.%${e}%`).join(",")).limit(3);if(i&&i.length>0){let e=i[0];return{answer:`HS code ${e.hs_code} - ${e.product_description}. MFN tariff: ${(100*e.mfn_tariff_rate).toFixed(1)}%, USMCA rate: ${(100*e.usmca_tariff_rate).toFixed(1)}%`,source:"comtrade_reference",confidence:95}}let r=await tryExternalHSCodeLookup(e,a);if(r)return r;let s=function(e){let t={electronics:{range:"8540-8548",examples:"Smartphones (851762), Computers (847130), Displays (854290), Battery controllers (850440)",description:"Electronics typically fall in Chapter 85 (Electrical Equipment)"},battery:{range:"8506-8507, 8504",examples:"Battery management systems (850440), Lithium batteries (850760), Battery chargers (850440)",description:"Battery systems typically in Chapter 85: Battery management/controllers (850440), Batteries (8507), Power supplies (8504)"},textiles:{range:"5000-6300",examples:"Cotton fabric (5208), Clothing (6109), Leather goods (4203)",description:"Textiles span Chapters 50-63 depending on material and use"},machinery:{range:"8400-8500",examples:"Industrial machines (8479), Tools (8467), Parts (8409)",description:"Machinery typically in Chapter 84 (Nuclear reactors, boilers, machinery)"},automotive:{range:"8700-8800",examples:"Vehicles (8703), Parts (8708), Tires (4011)",description:"Automotive products mainly in Chapter 87"},food:{range:"0100-2400",examples:"Meat (02), Dairy (04), Beverages (22)",description:"Food products in Chapters 1-24"}};for(let a of e)for(let[e,n]of Object.entries(t))if(a.includes(e)||e.includes(a))return{answer:`${n.description}. Range: ${n.range}. Examples: ${n.examples}. For exact classification, describe your specific product in more detail.`,source:"hs_category_guidance",confidence:70};return null}(a);return s||{answer:"I couldn't find that specific product in our database. Try describing it differently or contact our trade specialists for help.",source:"no_match",confidence:50}}async function handleTariffQuestion(e,t="en"){let a=["china","taiwan","vietnam","india","mexico","canada"].find(t=>e.includes(t));if(!a)return{answer:"Current tariff rates vary by country and product. China: 25% average, India: 50% average, USMCA (Mexico/Canada): 0%. Which country are you importing from?",source:"general_tariffs",confidence:80};let{data:n}=await c.from("usmca_tariff_rates").select("*").ilike("country",`%${a}%`).limit(1);return n&&n.length>0?{answer:`${a.toUpperCase()} tariff rates: USMCA qualified products get 0% tariff vs standard MFN rates. Triangle routing through Mexico/Canada can save 15-25% on duties.`,source:"usmca_tariff_rates",confidence:90}:{answer:({china:"China: 25% average tariffs, but triangle routing via Mexico can reduce to 0%",taiwan:"Taiwan: 15-20% average tariffs, USMCA triangle routing available",vietnam:"Vietnam: 10-15% average tariffs, consider Mexico triangle routing",india:"India: 30-50% average tariffs, significant savings with triangle routing",mexico:"Mexico: 0% under USMCA for qualified products",canada:"Canada: 0% under USMCA for qualified products"})[a]||`${a} tariff information not available in current database.`,source:"general_knowledge",confidence:75}}async function handleRoutingQuestion(e,t="en"){let{data:a}=await c.from("triangle_routing_opportunities").select("*").order("success_rate",{ascending:!1}).limit(3);if(a&&a.length>0){let e=a[0];return{answer:`Best triangle route: ${e.route_description||"Asia→Mexico→USA"}. Success rate: ${e.success_rate}%, average savings: $${(e.annual_savings||15e4).toLocaleString()}. Transit time: 14-18 days vs 35-45 direct.`,source:"triangle_routing_opportunities",confidence:90}}return{answer:"Triangle routing via Mexico/Canada offers 0% USMCA tariffs vs 25%+ direct rates. Typical setup: 60-90 days, savings: $100K-$300K annually. Transit time often faster than direct shipping.",source:"routing_knowledge",confidence:85}}async function handleMarketAlertsQuestion(e,t="en"){let{data:a}=await c.from("current_market_alerts").select("*").order("created_at",{ascending:!1}).limit(3);if(a&&a.length>0){let e=a.map(e=>`• ${e.alert_type}: ${e.description}`).join("\n");return{answer:`Current trade alerts:
${e}`,source:"current_market_alerts",confidence:95}}return{answer:"No active trade alerts in our database. Key areas to watch: US-China tariffs, USMCA updates, port congestion, and de minimis thresholds.",source:"general_alerts",confidence:70}}async function handlePeerQuestion(e,t="en"){let{data:a}=await c.from("workflow_sessions").select("data, stage_completed").not("data","is",null).limit(50);if(a&&a.length>0){let e=a.map(e=>e.data?.businessType).filter(Boolean).reduce((e,t)=>(e[t]=(e[t]||0)+1,e),{}),t=Object.values(e).reduce((e,t)=>e+t,0),n=Object.keys(e).reduce((t,a)=>e[t]>e[a]?t:a);return{answer:`We've analyzed ${t} companies. Most common: ${n} (${e[n]} companies). Average success rate: 89%. Most save $100K-$300K annually with triangle routing.`,source:"workflow_sessions",confidence:90}}return{answer:"Our database shows 240+ companies using triangle routing. Average savings: $250K annually, 92% success rate, 60-90 day implementation.",source:"platform_stats",confidence:80}}async function handleBusinessIntelligenceQuestion(e,t="en"){let{data:a}=await c.from("usmca_business_intelligence").select("*").order("success_rate_percentage",{ascending:!1}).limit(3);if(a&&a.length>0){let e=a.reduce((e,t)=>e+(t.success_rate_percentage||0),0)/a.length,t=a.reduce((e,t)=>e+(t.average_annual_savings||0),0)/a.length;return{answer:`Business intelligence: ${Math.round(e)}% average success rate, $${Math.round(t).toLocaleString()} average annual savings. Implementation time: 60-90 days typical.`,source:"usmca_business_intelligence",confidence:95}}return{answer:"Platform intelligence: 92% success rate, $250K average annual savings, 60-90 day implementation. Triangle routing works for 89% of electronics/manufacturing companies.",source:"general_intelligence",confidence:85}}async function handleHighValueBusinessQuestion(e,t="en"){let a=e.match(/\$([0-9.]+)\s*(million|M|k|K)?/i);(function(e){let t=e.match(/(\$?[0-9.]+)\s*(million|M|k|K)?\s*(annually|per year|yearly)/i);t&&t[0]})(e),["china","taiwan","vietnam","india","mexico","canada","korea","thailand"].filter(t=>e.toLowerCase().includes(t));let n="significant import volume",i="$100K-300K",r="substantial duties";if(a){let e=parseFloat(a[1]),t=a[2]?.toLowerCase(),s=e;("million"===t||"m"===t)&&(s=1e6*e),"k"===t&&(s=1e3*e),n=`$${formatCurrency(s)} annual volume`;let o=.25*s;r=`~$${formatCurrency(o)} in duties`;let c=.9*o;i=`$${formatCurrency(c)}`}let{data:s}=await c.from("triangle_routing_opportunities").select("*").order("success_rate",{ascending:!1}).limit(1),{data:o}=await c.from("usmca_business_intelligence").select("success_rate_percentage, average_annual_savings").order("success_rate_percentage",{ascending:!1}).limit(1),u=o?.[0]?.success_rate_percentage||89;return(o?.[0]?.average_annual_savings,e.includes("diversify")||e.includes("should")||e.includes("alternative"))?{answer:`With ${n} from China, you're paying ${r}. YES - diversification through triangle routing could save ${i} annually. ${u}% of similar businesses succeed with Mexico triangle routing. Triangle Intelligence would eliminate tariff volatility while maintaining supply security.`,source:"business_strategy_analysis",confidence:95}:{answer:`${n} from China represents major triangle routing opportunity. Estimated current tariff cost: ${r}. Potential annual savings: ${i} through Mexico USMCA routing. Success rate: ${u}%. Implementation: 60-90 days typical.`,source:"volume_analysis",confidence:90}}function formatCurrency(e){return e>=1e6?`${(e/1e6).toFixed(1)}M`:e>=1e3?`${(e/1e3).toFixed(0)}K`:e.toLocaleString()}async function handleGeneralProductQuestion(e,t="en"){let{data:a}=await c.from("comtrade_reference").select("hs_code, product_description").limit(5);return{answer:"I can help with HS codes, tariff rates, triangle routing, market alerts, and trade intelligence. Try asking: 'What's the HS code for [product]?' or 'What are China tariff rates?'",source:"help_guidance",confidence:100}}async function tryExternalHSCodeLookup(e,t){if(!process.env.COMTRADE_API_KEY)return null;try{let t=e.match(/hs code for ([^?]+)/)||e.match(/classification for ([^?]+)/)||e.match(/code for ([^?]+)/);if(!t)return null;let a=t[1].trim(),n=await fetch(`https://comtradeapi.un.org/data/v1/get/C/A/HS?cmdCode=TOTAL&partnerCode=0&reporter=842&period=2022&motCode=0&custCode=C00&fmt=json&head=H&max=1&q=${encodeURIComponent(a)}`,{headers:{"Ocp-Apim-Subscription-Key":process.env.COMTRADE_API_KEY}});if(n.ok){let e=await n.json();if(e.data&&e.data.length>0){let t=e.data[0].cmdCode,n=e.data[0].cmdDescE||a;if("TOTAL"===t||"AG2"===t||"AG4"===t||"AG6"===t)return null;try{await c.from("comtrade_reference").insert({hs_code:t,product_description:n,mfn_tariff_rate:.25,usmca_tariff_rate:0,data_source:"comtrade_api_lookup"})}catch(e){console.error("Failed to cache HS code in database:",e)}return{answer:`HS code ${t} - ${n}. Added to our database for faster future lookups. MFN tariff: ~25%, USMCA rate: 0%.`,source:"comtrade_api",confidence:85}}}}catch(e){console.error("External HS code lookup failed:",e)}return null}async function translateResponse(e,t){if("en"===t)return e;let a=function(e){let t={en:"Respond in English.",es:"Responde en espa\xf1ol. S\xe9 profesional y usa terminolog\xeda comercial apropiada.",fr:"R\xe9pondez en fran\xe7ais. Soyez professionnel et utilisez la terminologie commerciale appropri\xe9e."};return t[e]||t.en}(t);return process.env.ANTHROPIC_API_KEY,`${a} ${e}`}async function trackQuestionPattern(e,t){try{let a={question:e.trim(),session_id:t||`session_${Date.now()}`,timestamp:new Date().toISOString(),question_type:categorizeQuestion(e),keywords:function(e){let t=e.toLowerCase();return["electronics","smartphone","laptop","computer","phone","headphones","textiles","clothing","fabric","cotton","leather","boots","shoes","machinery","equipment","tools","automotive","parts","vehicles","solar","panel","battery","inverter","controller","management","food","agriculture","medical","devices","pharmaceutical","china","taiwan","vietnam","korea","india","thailand","malaysia","mexico","canada","usa","japan","germany","indonesia","manufacturing","import","export","supplier","sourcing","cost","savings","tariff","duty","compliance","shipping","logistics"].filter(e=>t.includes(e))}(e),created_at:new Date().toISOString()};await c.from("marcus_question_patterns").insert(a),console.log("\uD83D\uDCCA Question pattern tracked:",a.question_type)}catch(e){console.error("Failed to track question pattern:",e)}}async function enhanceWithMarcusIntelligence(e,t,a="en"){let n=categorizeQuestion(t),i=function(e,t,a){let n={hs_code_lookup:["What's your import volume for this product annually?","Are you currently importing this from China or another high-tariff country?","Have you explored Mexico manufacturing partnerships for this product?","What challenges are you facing with current suppliers?"],tariff_inquiry:["What's your current annual import volume affected by these tariffs?","Have you considered triangle routing to reduce these tariff costs?","Are tariff fluctuations affecting your business planning?","Would a 0% USMCA rate through Mexico interest you?"],routing_strategy:["What's your primary supplier country currently?","How important is transit time vs cost savings for your business?","Have you worked with Mexican manufacturing partners before?","What's your annual import volume for triangle routing analysis?"],cost_optimization:["What's your biggest supply chain cost challenge right now?","Have you quantified your potential triangle routing savings?","Are you exploring Mexico alternatives due to China trade uncertainty?","What would $100K-300K annual savings mean for your business?"],supplier_sourcing:["What criteria matter most: cost, quality, or delivery time?","Are you diversifying away from China suppliers?","Have you considered Mexico's manufacturing ecosystem?","What's your experience with USMCA supplier qualification?"],compliance_question:["Are you familiar with USMCA rules of origin requirements?","What compliance challenges worry you most about triangle routing?","Have you worked with customs brokers on complex routing?","Would you like guidance on Mexico manufacturing compliance?"],logistics_timing:["How critical are delivery schedules to your operations?","Are current shipping delays affecting your business?","Would 14-18 day Mexico routing work vs 35+ day direct shipping?","What's your tolerance for supply chain transition time?"],peer_comparison:["What industry sector is your business in?","Are you seeing competitors explore Mexico alternatives?","Would insights from similar businesses help your decision-making?","What's driving your interest in supply chain optimization?"],high_value_business:["What product categories make up your largest import volumes?","Are tariff fluctuations affecting your business planning and margins?","Have you explored Mexico manufacturing partnerships yet?","What would eliminating tariff volatility mean for your business growth?","Are you concerned about China trade policy uncertainty under Trump?","Would a detailed triangle routing analysis be valuable for your volumes?"],general_inquiry:["What specific trade challenge can I help you solve?","Are you exploring alternatives to China sourcing?","What's your biggest supply chain pain point right now?","How familiar are you with USMCA triangle routing opportunities?"]},i=n[e]||n.general_inquiry,r=Math.floor(Math.random()*i.length);return i[r]}(n,0,0),r=await gatherIntelligenceInsights(n,t),s=await translateResponse(e.answer,a),o=i?await translateResponse(i,a):i;return{answer:s,followUp:o,source:e.source,confidence:e.confidence,intelligenceGathered:r}}function categorizeQuestion(e){let t=e.toLowerCase();return t.includes("hs code")||t.includes("classification")?"hs_code_lookup":t.includes("tariff")||t.includes("duty")||t.includes("rate")?"tariff_inquiry":t.includes("route")||t.includes("mexico")||t.includes("triangle")?"routing_strategy":t.includes("save")||t.includes("cost")||t.includes("money")?"cost_optimization":t.includes("supplier")||t.includes("manufacturer")||t.includes("partner")?"supplier_sourcing":t.includes("compliance")||t.includes("legal")||t.includes("regulation")?"compliance_question":t.includes("time")||t.includes("fast")||t.includes("shipping")?"logistics_timing":t.includes("company")||t.includes("business")||t.includes("similar")?"peer_comparison":t.includes("$")||t.includes("million")||t.includes("import")||t.includes("annually")||t.includes("diversify")||t.includes("volume")||t.includes("china")&&(t.includes("should")||t.includes("alternative"))?"high_value_business":"general_inquiry"}async function gatherIntelligenceInsights(e,t){try{let{data:t}=await c.from("marcus_question_patterns").select("question_type, keywords, created_at").gte("created_at",new Date(Date.now()-6048e5).toISOString()).limit(100);if(!t)return null;let a=t.reduce((e,t)=>(e[t.question_type]=(e[t.question_type]||0)+1,e),{}),n=t.reduce((e,t)=>(t.keywords&&t.keywords.forEach(t=>{e[t]=(e[t]||0)+1}),e),{});return{trendingQuestionTypes:Object.entries(a).sort(([,e],[,t])=>t-e).slice(0,3).map(([e,t])=>({type:e,count:t})),trendingKeywords:Object.entries(n).sort(([,e],[,t])=>t-e).slice(0,5).map(([e,t])=>({keyword:e,count:t})),currentQuestionType:e,totalQuestions:t.length}}catch(e){return console.error("Failed to gather intelligence insights:",e),null}}let u=(0,s.l)(n,"default"),l=(0,s.l)(n,"config"),d=new i.PagesAPIRouteModule({definition:{kind:r.x.PAGES_API,page:"/api/trade-intelligence-chat",pathname:"/api/trade-intelligence-chat",bundlePath:"",filename:""},userland:n})}};var t=require("../../webpack-api-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),a=t.X(0,[4222],()=>__webpack_exec__(9736));module.exports=a})();