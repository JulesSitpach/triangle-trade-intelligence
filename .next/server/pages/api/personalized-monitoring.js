"use strict";(()=>{var e={};e.id=869,e.ids=[869],e.modules={2885:e=>{e.exports=require("@supabase/supabase-js")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},7650:(e,t,r)=>{r.r(t),r.d(t,{config:()=>l,default:()=>u,routeModule:()=>d});var i={};r.r(i),r.d(i,{default:()=>handler});var s=r(1802),a=r(7153),o=r(6249),n=r(2885);let c=(0,n.createClient)("https://mrwitpgbcaxgnirqtavt.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY);async function handler(e,t){if("POST"!==e.method)return t.status(405).json({error:"Method not allowed"});try{let{userProfile:r,hindsightInsights:i,monitoringPrefs:s={}}=e.body;console.log("\uD83C\uDFAF Personalized monitoring request:",{businessType:r?.businessType,origin:r?.origin,products:r?.products?.length||0});let a=function(e,t){let r={productPatterns:[],routePatterns:[],savingsThresholds:{},priorityFactors:[]};return e?.products&&e.products.forEach(e=>{r.productPatterns.push({hsCode:e.hsCode,description:e.description,category:e.category,searchTerms:[e.description?.toLowerCase(),e.category?.toLowerCase(),`hs ${e.hsCode}`].filter(Boolean)})}),t?.successPatterns?.topSavers&&t.successPatterns.topSavers.forEach(e=>{r.routePatterns.push({origin:e.reporter_country,destination:e.partner_country,stage:e.triangle_stage,minSavings:.1*e.estimated_usmca_savings})}),t?.peerBenchmarks?.averageSavings?r.savingsThresholds={high:2*t.peerBenchmarks.averageSavings,medium:t.peerBenchmarks.averageSavings,low:.5*t.peerBenchmarks.averageSavings}:r.savingsThresholds={high:1e6,medium:5e5,low:1e5},r.priorityFactors=[e?.businessType&&`business_${e.businessType.toLowerCase()}`,e?.origin&&`origin_${e.origin.toLowerCase()}`,e?.importVolume&&`volume_${e.importVolume}`,t?.actualSavings?.bestStage&&`stage_${t.actualSavings.bestStage}`].filter(Boolean),r}(r,i),o=await generatePersonalizedAlerts(a),n=o.sort((e,t)=>{let r={high:3,medium:2,low:1},i=r[t.priority]-r[e.priority];return 0!==i?i:t.relevanceScore-e.relevanceScore}).map((e,t)=>({...e,rank:t+1,displayOrder:t+1})),c={monitoringFocus:[r?.businessType&&`${r.businessType} industry trends`,r?.origin&&`${r.origin} trade developments`,i?.actualSavings?.bestStage&&`Stage ${i.actualSavings.bestStage} route opportunities`].filter(Boolean),alertFrequency:{high_priority:"daily",medium_priority:"weekly",low_priority:"monthly"},keyMetrics:["Product-specific savings opportunities","Route performance changes","Peer benchmark shifts","Market concentration updates"],customization:{productFocus:r?.products?.map(e=>e.category)||[],routeFocus:i?.routePerformance?.topDestination||"USA",savingsThreshold:i?.peerBenchmarks?.averageSavings||5e5}},u={alertCriteria:a,personalizedAlerts:n,monitoringPlan:c,relevanceScore:function(e,t){if(!e.length)return 0;let r=e.reduce((e,t)=>e+(t.relevanceScore||50),0)/e.length,i=e.filter(e=>"high"===e.priority).length,s=e.filter(e=>e.category?.includes("YOUR_")).length;return Math.round(r+5*i+10*s)}(n,0),lastUpdated:new Date().toISOString()};console.log("✅ Personalized monitoring intelligence generated"),t.json({success:!0,source:"PERSONALIZED_DATABASE_MONITORING",personalizedAlerts:n.length,personalizedIntelligence:u})}catch(e){console.error("❌ Personalized monitoring error:",e.message),t.status(500).json({success:!1,error:e.message})}}async function generatePersonalizedAlerts(e){let t=[];for(let r of e.productPatterns){let{data:i}=await c.from("trade_flows").select("product_description, trade_value, estimated_usmca_savings, reporter_country, partner_country, triangle_stage").or(r.searchTerms.map(e=>`product_description.ilike.%${e}%`).join(",")).gte("estimated_usmca_savings",e.savingsThresholds.medium).order("estimated_usmca_savings",{ascending:!1}).limit(5);if(i&&i.length>0){let s=i.reduce((e,t)=>e+(t.estimated_usmca_savings||0),0);t.push({type:"product_opportunity",priority:s>=e.savingsThresholds.high?"high":"medium",category:"YOUR_PRODUCTS",title:`${r.description} Optimization Opportunities`,message:`Found ${i.length} high-value routes for your specific products`,impact:`$${(s/1e6).toFixed(1)}M potential savings`,relevanceScore:95,action:`Review ${r.description} triangle routing options`,data:i,personalizedFor:r})}}for(let r of e.routePatterns){let{data:i}=await c.from("trade_flows").select("product_description, trade_value, estimated_usmca_savings, triangle_stage").eq("reporter_country",r.origin).eq("partner_country",r.destination).gte("estimated_usmca_savings",r.minSavings).order("estimated_usmca_savings",{ascending:!1}).limit(10);if(i&&i.length>0){let s=i.reduce((e,t)=>e+(t.estimated_usmca_savings||0),0)/i.length;t.push({type:"route_intelligence",priority:s>=e.savingsThresholds.high?"high":"medium",category:"YOUR_ROUTES",title:`${r.origin} → ${r.destination} Route Activity`,message:`${i.length} active opportunities on your preferred route`,impact:`$${(s/1e6).toFixed(1)}M average opportunity size`,relevanceScore:90,action:`Monitor ${r.origin} → ${r.destination} developments`,data:i,personalizedFor:r})}}let{data:r}=await c.from("trade_flows").select("reporter_country, partner_country, trade_value, estimated_usmca_savings, triangle_stage, product_description").in("reporter_country",e.routePatterns.map(e=>e.origin)).gte("estimated_usmca_savings",e.savingsThresholds.low).order("trade_value",{ascending:!1}).limit(15);if(r&&r.length>0){let i=r.reduce((e,t)=>e+(t.trade_value||0),0);t.push({type:"peer_benchmarking",priority:"medium",category:"MARKET_INTELLIGENCE",title:"Similar Companies Activity",message:`Companies with your profile show $${(i/1e6).toFixed(1)}M in recent activity`,impact:`${r.length} peer opportunities to analyze`,relevanceScore:75,action:"Review peer activity patterns",data:r,personalizedFor:e.priorityFactors})}return t}let u=(0,o.l)(i,"default"),l=(0,o.l)(i,"config"),d=new s.PagesAPIRouteModule({definition:{kind:a.x.PAGES_API,page:"/api/personalized-monitoring",pathname:"/api/personalized-monitoring",bundlePath:"",filename:""},userland:i})}};var t=require("../../webpack-api-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),r=t.X(0,[4222],()=>__webpack_exec__(7650));module.exports=r})();