"use strict";(()=>{var e={};e.id=2290,e.ids=[2290],e.modules={2885:e=>{e.exports=require("@supabase/supabase-js")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},688:(e,s,n)=>{n.r(s),n.d(s,{config:()=>m,default:()=>p,routeModule:()=>h});var t={};n.r(t),n.d(t,{default:()=>handler});var o=n(1802),i=n(7153),a=n(6249),r=n(9475),c=n(2885);let l=require("fs");var d=n.n(l);let u=require("path");var g=n.n(u);(function(){var e=Error("Cannot find module '../../../lib/api-logger'");throw e.code="MODULE_NOT_FOUND",e})(),function(){var e=Error("Cannot find module '../../../lib/unified-hs-classifier.js'");throw e.code="MODULE_NOT_FOUND",e}();let f=(0,c.createClient)("https://mrwitpgbcaxgnirqtavt.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY);async function handler(e,s){if(Object(function(){var e=Error("Cannot find module '../../../lib/api-logger'");throw e.code="MODULE_NOT_FOUND",e}())("/api/intelligence/hs-codes",{method:e.method,body:e.body,timestamp:new Date().toISOString()}),"PUT"===e.method)return handleLearning(e,s);if("POST"!==e.method)return s.status(405).json({error:"Method not allowed"});let{productDescription:n,businessType:t}=e.body;if(!n?.trim())return s.status(400).json({error:"Product description is required",suggestions:[]});try{console.log(`🚀 DATABASE-ONLY HS CLASSIFICATION: "${n}" (${t})`);try{console.log("\uD83D\uDD0D Using database-driven classification (597K trade flows + 17K HS codes)...");let e=Object(function(){var e=Error("Cannot find module '../../../lib/unified-hs-classifier.js'");throw e.code="MODULE_NOT_FOUND",e}())(),o=await e.classifyProduct(n.trim(),t?.trim()||"");if(o&&o.length>0){let e=o.filter(e=>e.confidence>=80);if(e.length>0)return console.log(`🎯 Database classifier found ${e.length} high-confidence matches`),console.log(`🏆 Best match: ${e[0].code} - ${e[0].description} (${e[0].confidence}% confidence)`),s.status(200).json({suggestions:e,source:"database_driven_classifier",method:"trade_data_intelligence",hardcoded:!1,dynamic:!0,databaseRecordsUsed:"597K+ trade records",totalSuggestions:e.length});console.log(`⚠️ Database found ${o.length} matches but all low confidence (${o[0]?.confidence}%)`),console.log("\uD83E\uDDE0 Trying business type intelligence instead...")}else console.log("\uD83D\uDCCB Database classifier no matches, trying business type intelligence...")}catch(e){console.error("❌ Database classifier error:",e),console.log("\uD83D\uDCCB Falling back to dynamic classifier...")}console.log("\uD83E\uDDE0 Using business type intelligence (Electronics = 84xx/85xx codes)...");let e=Object(function(){var e=Error("Cannot find module '../../../lib/unified-hs-classifier.js'");throw e.code="MODULE_NOT_FOUND",e}())(),o=e.generateBusinessTypeFallback(n.trim(),t?.trim()||"");if(o.length>0)return console.log(`✅ Business type intelligence: Found ${o.length} matches for ${t}`),console.log(`🏆 Business type match: ${o[0].code} - ${o[0].description} (${o[0].confidence}% confidence)`),s.status(200).json({suggestions:o,source:"business_type_intelligence",method:"smart_business_type_mapping",hardcoded:!1,dynamic:!0,apiCallsMade:0,businessTypeUsed:t,classificationApproach:"Business type → HS code mapping (instant)",costOptimized:!0,totalSuggestions:o.length});console.log("\uD83C\uDFAF Using generic classification fallback...");let i=await e.generateFallback(t?.trim()||"");return console.log(`✅ DATABASE SUCCESS: Found ${i.length} matches`),i.length>0&&(console.log(`🎯 Top match: ${i[0].code} - ${i[0].description} (${i[0].confidence}%)`),console.log(`📊 Source: ${i[0].source}`)),s.status(200).json({suggestions:i,source:"database_only_classification",method:"pure_database_driven",hardcoded:!1,dynamic:!0,apiCallsMade:0,databaseRecordsUsed:"597K+ trade flows + 17K+ HS codes",classificationApproach:"Database-only HS classification (no API waste)",costOptimized:!0,totalSuggestions:i.length})}catch(e){return r.kg.error("DATABASE CLASSIFICATION ERROR:",e),s.status(500).json({error:"Classification service temporarily unavailable",message:"Database-driven classification failed",suggestions:[],fallback:"Please try again or contact support for manual classification"})}}async function handleLearning(e,s){try{let n=e.body;console.log("\uD83E\uDDE0 LEARNING: Recording HS code selection:",{product:n.productDescription,hsCode:n.selectedHSCode,businessType:n.businessType,company:n.companyName});try{let{data:e,error:t}=await f.from("hs_code_learning").insert({product_description:n.productDescription,selected_hs_code:n.selectedHSCode,business_type:n.businessType,company_name:n.companyName,user_session_id:n.sessionId||"anonymous",confidence_score:n.confidenceScore||null,timestamp:new Date,learning_source:"user_selection"}).select();if(t)throw t;return console.log("✅ Learning data stored in database successfully"),s.status(200).json({success:!0,message:"HS code selection recorded for institutional learning",learningId:e[0]?.id,source:"database_learning"})}catch(a){console.warn("Database learning failed, falling back to file system:",a.message);let e=g().join(process.cwd(),"memory","hs-code-learning.json"),t=g().dirname(e);d().existsSync(t)||d().mkdirSync(t,{recursive:!0});let o=[];if(d().existsSync(e))try{let s=d().readFileSync(e,"utf8");o=JSON.parse(s)}catch(e){console.warn("Failed to parse existing learning data:",e)}let i={...n,timestamp:new Date().toISOString(),id:`learning_${Date.now()}_${Math.random().toString(36).substr(2,9)}`};return o.push(i),d().writeFileSync(e,JSON.stringify(o,null,2)),console.log("✅ Learning data stored in file system (fallback)"),s.status(200).json({success:!0,message:"HS code selection recorded for institutional learning (file backup)",totalLearningEntries:o.length,source:"file_learning_fallback"})}}catch(e){return console.error("❌ LEARNING ERROR:",e),s.status(500).json({success:!1,error:"Failed to record learning data",message:e.message})}}let p=(0,a.l)(t,"default"),m=(0,a.l)(t,"config"),h=new o.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/intelligence/hs-codes",pathname:"/api/intelligence/hs-codes",bundlePath:"",filename:""},userland:t})}};var s=require("../../../webpack-api-runtime.js");s.C(e);var __webpack_exec__=e=>s(s.s=e),n=s.X(0,[4222,9475],()=>__webpack_exec__(688));module.exports=n})();