"use strict";(()=>{var e={};e.id=5564,e.ids=[5564],e.modules={2885:e=>{e.exports=require("@supabase/supabase-js")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},5918:(e,t,a)=>{a.r(t),a.d(t,{config:()=>g,default:()=>d,routeModule:()=>p});var i={};a.r(i),a.d(i,{default:()=>handler});var n=a(1802),s=a(7153),r=a(6249),o=a(9475),l=a(7309),c=a(2885);let u=(0,c.createClient)("https://mrwitpgbcaxgnirqtavt.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY);async function handler(e,t){if(o.kg.info("API CALL: /api/intelligence/routing",{method:e.method,body:e.body,timestamp:new Date().toISOString()}),"POST"!==e.method)return t.status(405).json({error:"Method not allowed"});let{products:a,businessProfile:i,businessType:n,importVolume:s,supplierCountry:r,productCategories:c,blaze:d}=e.body,g=!0===d||"true"===e.query.blaze||void 0!==n;try{if(g){console.log("\uD83D\uDD25 BLAZE ROUTING: Finding $100K-$300K+ opportunities...");let e=n||i?.businessType,a=s||i?.importVolume,o=r||i?.primarySupplierCountry||"China",{data:l,error:c}=await u.from("triangle_routing_opportunities").select("*").gte("max_savings_amount",1e5).order("max_savings_amount",{ascending:!1}).limit(5);if(c)throw c;let{data:d,error:g}=await u.from("hindsight_pattern_library").select("*").contains("business_types_applicable",[e]).order("success_rate_percentage",{ascending:!1}).limit(3),{data:p,error:m}=await u.from("current_market_alerts").select("*").eq("is_active",!0).contains("affected_countries",[o]).limit(2),_=l.map(e=>{var t;let i={"Under $500K":.25,"$500K - $1M":.75,"$1M - $5M":2.5,"$5M - $25M":12.5,"Over $25M":35}[a]||1,n=Math.round(e.max_savings_amount*i);return{...e,personalized_savings:n,roi_percentage:(n/(1e6*i)*100).toFixed(1),implementation_priority:n>2e5?"HIGH":"MEDIUM",payback_period:(t=e.route_complexity_score,Math.max(3,2*t+6+(n>25e4?-2:0))+" months")}}),h=function(e,t,a){let i=e[0],n=[];return i&&(n.push(`ðŸŽ¯ Primary Recommendation: ${i.optimal_route.replace("via_","")} route saves $${(i.personalized_savings/1e3).toFixed(0)}K annually`),i.success_rate>90&&n.push(`âœ… High Success Rate: ${i.success_rate}% of similar businesses succeeded with this route`),t?.length>0&&n.push(`ðŸ§  Pattern Match: Similar ${t[0].business_types_applicable.join("/")} companies achieved ${t[0].success_rate_percentage}% success rate`),a?.length>0&&n.push(`âš¡ Market Alert: Current ${a[0].alert_type.toLowerCase()} creates immediate optimization opportunity`)),n}(_,d,p);return t.status(200).json({success:!0,routing_intelligence:{high_value_routes:_,total_potential_savings:_.reduce((e,t)=>e+t.personalized_savings,0),best_route:_[0],implementation_timeline:"45-90 days",blaze_optimized:!0},institutional_patterns:d,market_intelligence:p,marcus_ai_insights:h,data_sources:{routing_opportunities:l.length,success_patterns:d?.length||0,market_alerts:p?.length||0,confidence_score:94.2}})}{console.log("\uD83C\uDFAF USING 597K TRADE FLOWS DATABASE..."),console.log(`   Products: ${a?.length||0} items`),console.log(`   Business: ${i?.businessType||i?.type||"NOT_FOUND"}`),console.log(`   Volume: ${i?.importVolume||i?.volume||"NOT_FOUND"}`),console.log("   Full businessProfile:",JSON.stringify(i));let e={origin:i?.primarySupplierCountry||"China",destination:"USA",hsCode:a?.[0]?.hsCode||"8471",businessType:i?.businessType||i?.type||"Electronics"};console.log("\uD83D\uDCCA Querying trade flows database:",e);let n=await l.ZP.getTriangleRoutingIntelligence(e);if(console.log("âœ… TRADE FLOWS RESPONSE:",{directFlows:n.direct.flow.records?.length||0,triangleOptions:n.triangleOptions?.length||0,dataQuality:n.analysis.dataQuality,apiCallsMade:n.efficiency.apiCallsMade,responseTime:n.efficiency.responseTime}),!i||!a||0===a.length)return console.log("âš ï¸ No valid user data (businessProfile or products missing), returning empty routes"),t.status(200).json({routes:[],source:"no_user_data",message:"Complete Foundation and Product stages first",intelligence:n.analysis,efficiency:n.efficiency});console.log("\uD83D\uDEE0ï¸ Creating dynamic routes based on origin:",e.origin,"destination:",e.destination);let s=e.origin,r=e.destination,o=[];return["US","CA","MX"].includes(s)||(o.push({id:"mexico_triangle",name:`${getCountryName(s)} â†’ Mexico â†’ ${getCountryName(r)}`,description:`USMCA triangle route via Mexico using ${n.triangleOptions?.length||0} database records`,transitTime:"28-35 days",complexity:"Medium",savings:calculateSavings(i?.importVolume,"mexico"),recommended:!0,tariffRate:"0% (USMCA)",databaseValidated:!0,tradeData:{viable:!0,leg1Records:n.triangleOptions?.[0]?.leg1?.length||0,leg2Records:n.triangleOptions?.[0]?.leg2?.length||0}}),("USA"===r||"US"===r)&&o.push({id:"canada_triangle",name:`${getCountryName(s)} â†’ Canada â†’ USA`,description:`Alternative USMCA route via Canada with ${n.triangleOptions?.length||0} database options`,transitTime:"25-32 days",complexity:"Medium",savings:calculateSavings(i?.importVolume,"canada"),recommended:!1,tariffRate:"0% (USMCA)",databaseValidated:!0,tradeData:{viable:!0,leg1Records:n.triangleOptions?.[1]?.leg1?.length||0,leg2Records:n.triangleOptions?.[1]?.leg2?.length||0}})),o.push({id:"direct_route",name:`${getCountryName(s)} â†’ ${getCountryName(r)} (Direct)`,description:"Direct import route - higher tariff exposure",transitTime:"18-25 days",complexity:"Low",savings:"Baseline (no triangle savings)",recommended:!1,tariffRate:["CN","IN","VN","TH"].includes(s)?"25-30% (Bilateral)":"5-15% (Standard)",databaseValidated:!0,tradeData:{viable:!0,leg1Records:n.direct?.flow?.records?.length||0,leg2Records:0}}),t.status(200).json({routes:o,source:"trade_flows_database",apiCall:!1,intelligence:n.analysis,efficiency:n.efficiency,recordsAnalyzed:n.direct.flow.totalRecords||597e3})}}catch(e){return o.kg.error("API ERROR in routing endpoint",{error:e.message,stack:e.stack}),console.error("FULL ERROR DETAILS:",e),t.status(500).json({error:"Failed to get routing options",message:e.message,stack:e.stack})}}function getCountryName(e){return({CN:"China",VN:"Vietnam",TW:"Taiwan",KR:"South Korea",IN:"India",TH:"Thailand",MY:"Malaysia",JP:"Japan",ID:"Indonesia",PH:"Philippines",BD:"Bangladesh",SG:"Singapore",DE:"Germany",NL:"Netherlands",GB:"United Kingdom",IT:"Italy",PL:"Poland",TR:"Turkey",FR:"France",AE:"United Arab Emirates",ZA:"South Africa",EG:"Egypt",AU:"Australia",NZ:"New Zealand",CZ:"Czech Republic",HU:"Hungary",US:"USA",USA:"USA",CA:"Canada",MX:"Mexico"})[e]||e}function calculateSavings(e,t){return`Up to $${Math.round(Math.round(({"Under $500K":35e3,"$500K - $1M":7e4,"$1M - $5M":18e4,"$5M - $25M":75e4,"Over $25M":2e6}[e]||12e4)*(({mexico:1,canada:.9})[t]||1))/1e3)}K annually`}let d=(0,r.l)(i,"default"),g=(0,r.l)(i,"config"),p=new n.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/intelligence/routing",pathname:"/api/intelligence/routing",bundlePath:"",filename:""},userland:i})}};var t=require("../../../webpack-api-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),a=t.X(0,[4222,9475,7309],()=>__webpack_exec__(5918));module.exports=a})();