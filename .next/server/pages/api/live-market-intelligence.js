"use strict";(()=>{var e={};e.id=3622,e.ids=[3622],e.modules={2885:e=>{e.exports=require("@supabase/supabase-js")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},8057:(e,t,a)=>{a.r(t),a.d(t,{config:()=>c,default:()=>u,routeModule:()=>d});var i={};a.r(i),a.d(i,{default:()=>handler});var r=a(1802),s=a(7153),n=a(6249),o=a(2885);let l=(0,o.createClient)("https://mrwitpgbcaxgnirqtavt.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY);async function handler(e,t){if("POST"!==e.method)return t.status(405).json({error:"Method not allowed"});try{let{businessType:a="Electronics",origin:i="China",destination:r="USA",products:s=[],hsCode:n=null}=e.body;console.log("\uD83D\uDCE1 Live market intelligence request:",{businessType:a,origin:i,destination:r});let o=await getLiveMarketAlerts(a,i,r),l=await getVolumeChanges(a,i),u=await getSavingsOpportunities(i,r),c=await getPeerActivity(a),d={marketAlerts:o,volumeChanges:l,savingsOpportunities:u,peerActivity:c,lastUpdated:Date.now(),dataSource:"LIVE_DATABASE_MONITORING"};console.log("✅ Live market intelligence generated from database"),t.json({success:!0,source:"REAL_DATABASE_MONITORING",alertsGenerated:o.length,liveIntelligence:d})}catch(e){console.error("❌ Live market intelligence error:",e.message),t.status(500).json({success:!1,error:e.message,liveIntelligence:null})}}async function getLiveMarketAlerts(e,t,a){let i=[],{data:r}=await l.from("trade_flows").select("trade_value, estimated_usmca_savings, product_description").ilike("product_description",`%${e.toLowerCase()}%`).eq("reporter_country",t).gte("estimated_usmca_savings",5e5).order("estimated_usmca_savings",{ascending:!1}).limit(5);if(r&&r.length>0){let t=r.reduce((e,t)=>e+t.estimated_usmca_savings,0);i.push({type:"high_opportunity",priority:"high",title:`High-Value ${e} Routes Identified`,message:`Found ${r.length} routes with $${(t/1e6).toFixed(1)}M+ total savings potential`,impact:`$${(t/1e6).toFixed(1)}M potential`,action:"Review triangle routing options",routes:r.map(e=>({product:e.product_description,savings:e.estimated_usmca_savings,value:e.trade_value}))})}let{data:s}=await l.from("trade_flows").select("triangle_stage, estimated_usmca_savings, partner_country").eq("reporter_country",t).ilike("product_description",`%${e.toLowerCase()}%`).not("estimated_usmca_savings","is",null);if(s&&s.length>0){let t={};s.forEach(e=>{let a=e.triangle_stage;t[a]||(t[a]={count:0,totalSavings:0}),t[a].count++,t[a].totalSavings+=e.estimated_usmca_savings});let a=Object.keys(t).reduce((e,a)=>t[a].totalSavings>(t[e]?.totalSavings||0)?a:e,"1");i.push({type:"route_optimization",priority:"medium",title:"Optimal Route Analysis",message:`Route ${a} shows highest efficiency for ${e} products`,impact:`$${(t[a].totalSavings/1e6).toFixed(1)}M avg savings`,action:`Focus on Route ${a} triangle routing`,routes:t})}let{data:n}=await l.from("trade_flows").select("partner_country, trade_value, estimated_usmca_savings").eq("reporter_country",t).ilike("product_description",`%${e.toLowerCase()}%`).order("trade_value",{ascending:!1}).limit(10);if(n&&n.length>0){let a={};n.forEach(e=>{let t=e.partner_country;a[t]||(a[t]={count:0,totalValue:0,totalSavings:0}),a[t].count++,a[t].totalValue+=e.trade_value,a[t].totalSavings+=e.estimated_usmca_savings||0});let r=Object.keys(a).reduce((e,t)=>a[t].totalValue>(a[e]?.totalValue||0)?t:e,"USA");i.push({type:"market_concentration",priority:"medium",title:"Market Concentration Analysis",message:`${r} represents highest trade value concentration for ${e}`,impact:`$${(a[r].totalValue/1e6).toFixed(1)}M trade value`,action:`Prioritize ${t} → ${r} routes`,destinations:a})}return i}async function getVolumeChanges(e,t){let{data:a}=await l.from("trade_flows").select("trade_value, triangle_stage, product_description").eq("reporter_country",t).ilike("product_description",`%${e.toLowerCase()}%`).order("trade_value",{ascending:!1}).limit(20),i=a?.reduce((e,t)=>e+(t.trade_value||0),0)||0,r=a?.length>0?i/a.length:0;return{totalTradeVolume:i,averageTradeValue:r,recordCount:a?.length||0,trend:i>1e8?"increasing":i>1e7?"stable":"monitoring",insight:`${e} from ${t}: $${(i/1e6).toFixed(1)}M total volume across ${a?.length} routes`}}async function getSavingsOpportunities(e,t){let{data:a}=await l.from("trade_flows").select("product_description, estimated_usmca_savings, triangle_stage, trade_value").eq("reporter_country",e).eq("partner_country",t).gte("estimated_usmca_savings",1e5).order("estimated_usmca_savings",{ascending:!1}).limit(10),i=a?.reduce((e,t)=>e+(t.estimated_usmca_savings||0),0)||0;return{totalOpportunities:a?.length||0,totalSavingsPotential:i,averageSavings:a?.length>0?i/a.length:0,topOpportunities:a?.slice(0,5).map(e=>({product:e.product_description,savings:e.estimated_usmca_savings,routeStage:e.triangle_stage,value:e.trade_value}))||[],insight:`${a?.length||0} active opportunities worth $${(i/1e6).toFixed(1)}M in potential savings`}}async function getPeerActivity(e){let{data:t}=await l.from("trade_flows").select("reporter_country, partner_country, trade_value, triangle_stage").ilike("product_description",`%${e.toLowerCase()}%`).not("trade_value","is",null).order("trade_value",{ascending:!1}).limit(15),a={},i={};t?.forEach(e=>{let t=`${e.reporter_country} → ${e.partner_country}`;a[t]=(a[t]||0)+1;let r=e.triangle_stage;i[r]=(i[r]||0)+1});let r=Object.keys(a).reduce((e,t)=>a[t]>(a[e]||0)?t:e,"China → USA"),s=Object.keys(i).reduce((e,t)=>i[t]>(i[e]||0)?t:e,"1");return{totalPeers:t?.length||0,topRoute:r,preferredRoute:s,routeDistribution:a,routeStageDistribution:i,insight:`${e} companies favor ${r} routes using Route ${s} triangle routing`}}let u=(0,n.l)(i,"default"),c=(0,n.l)(i,"config"),d=new r.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/live-market-intelligence",pathname:"/api/live-market-intelligence",bundlePath:"",filename:""},userland:i})}};var t=require("../../webpack-api-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),a=t.X(0,[4222],()=>__webpack_exec__(8057));module.exports=a})();