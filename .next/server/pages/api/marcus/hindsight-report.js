"use strict";(()=>{var e={};e.id=2551,e.ids=[2551],e.modules={2885:e=>{e.exports=require("@supabase/supabase-js")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},7174:e=>{e.exports=import("@anthropic-ai/sdk")},4308:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{config:()=>u,default:()=>l,routeModule:()=>d});var n=a(1802),i=a(7153),o=a(6249),s=a(1357),c=e([s]);s=(c.then?(await c)():c)[0];let l=(0,o.l)(s,"default"),u=(0,o.l)(s,"config"),d=new n.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/marcus/hindsight-report",pathname:"/api/marcus/hindsight-report",bundlePath:"",filename:""},userland:s});r()}catch(e){r(e)}})},1357:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{default:()=>handler});var n=a(2885),i=a(7174),o=e([i]);i=(o.then?(await o)():o)[0];let s=(0,n.createClient)("https://mrwitpgbcaxgnirqtavt.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY),c=process.env.ANTHROPIC_API_KEY?new i.default({apiKey:process.env.ANTHROPIC_API_KEY}):null;async function handler(e,t){if("POST"!==e.method)return t.status(405).json({error:"Method not allowed"});let{foundationData:a,productData:r,routingData:n}=e.body;if(!a||!r||!n)return t.status(400).json({error:"Missing required page data"});try{let{data:e}=await s.from("workflow_sessions").select("*").eq("data->businessType",a.businessType).limit(20),{data:i}=await s.from("hindsight_pattern_library").select("*").order("confidence_score",{ascending:!1}).limit(10),{data:o}=await s.from("trade_flows").select("*").in("hs_code",r.products?.map(e=>e.hsCode)||[]).eq("usmca_qualified",!0).limit(50),l=function(e,t,a,r,n){var i;let o=r?.filter(t=>t.data?.importVolume===e.importVolume).length||0,s=r?.reduce((e,t)=>{let a=t.data?.routingData?.potentialSavings||0;return e+a},0)/(r?.length||1),c=r?.filter(e=>e.stage_completed>=8).length/(r?.length||1)*100;a.selectedRoute;let l=n?.filter(e=>e.trade_flow?.includes("Mexico")&&e.usmca_qualified).length/(n?.length||1)*100;return{similarCompaniesAnalyzed:o,averageSavingsAchieved:Math.round(s),successRatePercentage:Math.round(c),routeViabilityScore:Math.round(l),implementationComplexity:function(e,t){let a=t.products?.length||0,r=t.averageConfidence||0;return a>10||r<70?"High":a>5||r<85?"Medium":"Low"}(0,t),paybackPeriodMonths:(i=a.potentialSavings,Math.ceil(75e3/(i/12))),riskAdjustedROI:function(e,t){let a=Math.min(75e3,.02*(({"Under $500K":25e4,"$500K - $1M":75e4,"$1M - $5M":3e6,"$5M - $25M":15e6,"Over $25M":5e7})[t]||1e6));return Math.round((e-a)/a*100)}(a.potentialSavings,e.importVolume),overallConfidence:Math.round((c+l)/2)}}(a,r,n,e,o),u=null;c&&(u=await generateMarcusReport(a,r,n,l,i));let d=function(e,t,a,r){let n=[];r.successRatePercentage>70&&n.push({pattern_type:"business_success",business_type:e.businessType,import_volume:e.importVolume,success_factors:[`${a.selectedRoute} routing`,`${t.products?.length} products analyzed`,`${r.overallConfidence}% confidence`],failure_points:[],confidence_score:r.overallConfidence,extracted_from:"user_journey",created_at:new Date().toISOString()});let i=function(e){if(!e||0===e.length)return null;let t=e.map(e=>e.category).filter(Boolean),a=t.reduce((e,t)=>(e[t]=(e[t]||0)+1,e),{});return Object.keys(a).reduce((e,t)=>a[e]>a[t]?e:t,null)}(t.products);return i&&a.potentialSavings>1e5&&n.push({pattern_type:"product_category",business_type:e.businessType,category:i,success_factors:[`High savings potential in ${i}`,"USMCA qualification confirmed"],confidence_score:t.averageConfidence||85,created_at:new Date().toISOString()}),n}(a,r,n,l);return d.length>0&&await s.from("hindsight_pattern_library").insert(d),u&&await s.from("marcus_consultations").insert({business_profile:{type:a.businessType,volume:a.importVolume,suppliers:a.primarySupplierCountry},recommendations:u.recommendations,savings_identified:n.potentialSavings,confidence_score:u.confidence,created_at:new Date().toISOString()}),t.status(200).json({success:!0,hindsightReport:{institutionalMetrics:l,marcusAnalysis:u,extractedPatterns:d,similarCompanies:e?.length||0,confidenceScore:l.overallConfidence}})}catch(e){return console.error("Hindsight report error:",e),t.status(500).json({error:"Failed to generate hindsight report",details:e.message})}}async function generateMarcusReport(e,t,a,r,n){if(!c)return null;let i=`You are Marcus, having a conversation with this business owner about what we learned from their triangle routing analysis.

Here's what happened in their journey:

THEIR BUSINESS:
- ${e.businessType} company
- Importing ${e.importVolume} from ${e.primarySupplierCountry}
- ${e.urgencyLevel?`They were ${e.urgencyLevel} urgency`:"Strategic planning mode"}

PRODUCTS WE ANALYZED:
${t.products?.map(e=>`${e.description} (HS: ${e.hsCode}, ${e.confidence}% confidence match)`).join(", ")}

WHAT THEY CHOSE:
- Selected: ${a.selectedRoute}
- Potential Annual Savings: $${a.potentialSavings?.toLocaleString()}

WHAT OUR DATA SHOWS:
- I've helped ${r.similarCompaniesAnalyzed} other ${e.businessType} companies like yours
- They averaged $${r.averageSavingsAchieved?.toLocaleString()} in savings
- Success rate: ${r.successRatePercentage}% complete their implementations
- Your chosen route has ${r.routeViabilityScore}% viability based on real trade data

Write as Marcus having a personal conversation about what worked, what we learned, and what this means for other similar businesses. Be conversational, direct, and focus on practical takeaways. Start with something like "Looking back at your triangle routing journey..." or "Here's what I learned from working with your business..."

Keep it under 300 words, conversational tone, no bullet points or formal sections.`;try{let e=await c.messages.create({model:"claude-3-haiku-20240307",max_tokens:1e3,messages:[{role:"user",content:i}]}),t=e.content[0].text;return{recommendations:t,confidence:r.overallConfidence,generatedAt:new Date().toISOString()}}catch(t){return console.error("Marcus AI error:",t),{recommendations:`Looking back at your triangle routing journey, here's what really stood out to me. Your ${e.businessType} business with ${e.importVolume} in volume puts you right in the sweet spot - I've worked with ${r.similarCompaniesAnalyzed} similar companies, and they typically save around $${r.averageSavingsAchieved?.toLocaleString()} annually.

What I found interesting about your case is that ${a.selectedRoute} route you chose has a ${r.routeViabilityScore}% success rate based on real trade data from companies just like yours. The ${r.implementationComplexity.toLowerCase()} complexity level means you should see payback within ${r.paybackPeriodMonths} months, which is actually pretty solid.

Here's what I learned that'll help other ${e.businessType} importers: focus on your highest-confidence products first - anything above 85% confidence. The companies that succeed roll this out in phases rather than trying to do everything at once. ${"high"===e.urgencyLevel?"I know you were feeling time pressure, but that actually helped you make decisive choices.":"Taking the strategic approach like you did usually leads to better long-term results."}

The ${r.successRatePercentage}% completion rate for businesses like yours tells me you're on the right track. Your risk-adjusted ROI of ${r.riskAdjustedROI}% is solid, especially in today's volatile tariff environment. Keep monitoring quarterly - tariffs change, but USMCA benefits stay stable.

This assessment comes from real outcomes in our institutional database, not theoretical projections.`,confidence:r.overallConfidence,generatedAt:new Date().toISOString()}}}r()}catch(e){r(e)}})}};var t=require("../../../webpack-api-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),a=t.X(0,[4222],()=>__webpack_exec__(4308));module.exports=a})();