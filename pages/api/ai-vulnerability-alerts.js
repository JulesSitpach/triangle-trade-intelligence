/**
 * AI-POWERED VULNERABILITY ALERTS
 * Analyzes USMCA workflow results to generate personalized trade risk alerts
 * Uses component origins to identify geopolitical and tariff vulnerabilities
 *
 * üîÑ 3-Tier Fallback Architecture:
 * TIER 1: OpenRouter ‚Üí TIER 2: Anthropic ‚Üí TIER 3: Graceful fail
 */

import { executeAIWithFallback, parseAIResponse } from '../../lib/ai-helpers.js';
import { logInfo, logError } from '../../lib/utils/production-logger.js';
import { logDevIssue, DevIssue } from '../../lib/utils/logDevIssue.js';
import { createClient } from '@supabase/supabase-js';
import { parse } from 'cookie';
import crypto from 'crypto';

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL,
  process.env.SUPABASE_SERVICE_ROLE_KEY
);

function verifySession(cookieValue) {
  try {
    if (!cookieValue) return null;

    const decoded = Buffer.from(cookieValue, 'base64').toString('utf-8');
    const { data, sig } = JSON.parse(decoded);

    const secret = process.env.JWT_SECRET || 'fallback-secret-change-in-production';
    const expectedSig = crypto.createHmac('sha256', secret)
      .update(JSON.stringify(data))
      .digest('hex');

    if (sig !== expectedSig) return null;

    const sevenDaysMs = 7 * 24 * 60 * 60 * 1000;
    if (Date.now() - data.timestamp > sevenDaysMs) return null;

    return data;
  } catch (error) {
    return null;
  }
}

export default async function handler(req, res) {
  if (req.method !== 'POST') {
    return res.status(405).json({ success: false, error: 'Method not allowed' });
  }

  try {
    const workflowData = req.body;

    console.log('üö® ========== AI VULNERABILITY ANALYSIS: START ==========');
    console.log('üì• Workflow data received:', {
      company: workflowData.company?.name,
      product: workflowData.product?.description,
      component_count: workflowData.component_origins?.length || workflowData.components?.length,
      usmca_qualified: workflowData.usmca?.qualified
    });

    // Validate required data
    if (!workflowData.component_origins && !workflowData.components) {
      await DevIssue.missingData('vulnerability_alerts_api', 'workflowData.component_origins', {
        endpoint: '/api/ai-vulnerability-alerts',
        hasCompany: !!workflowData.company,
        hasProduct: !!workflowData.product
      });
      return res.status(400).json({
        success: false,
        error: 'No component origins data found. Complete USMCA workflow first.'
      });
    }

    const components = workflowData.component_origins || workflowData.components || [];

    // ========== LOG MISSING OPTIONAL FIELDS (for admin review) ==========
    const missingOptionalFields = [];

    if (!workflowData.company?.name && !workflowData.company?.company_name) missingOptionalFields.push('company_name');
    if (!workflowData.product?.description && !workflowData.product?.product_description) missingOptionalFields.push('product_description');
    if (!workflowData.company?.business_type) missingOptionalFields.push('business_type');
    if (!workflowData.company?.destination_country) missingOptionalFields.push('destination_country');
    if (!workflowData.company?.supplier_country) missingOptionalFields.push('supplier_country');
    if (!workflowData.product?.hs_code) missingOptionalFields.push('hs_code');

    if (missingOptionalFields.length > 0) {
      // Log to admin dashboard (non-blocking)
      await DevIssue.missingData('vulnerability_alerts', missingOptionalFields.join(', '), {
        user_id: session?.userId || 'unknown',
        workflow_step: 'ai_vulnerability_analysis',
        impact: 'AI vulnerability analysis quality may be reduced due to missing context',
        missing_fields: missingOptionalFields
      });
      console.log(`‚ö†Ô∏è  Missing optional fields: ${missingOptionalFields.join(', ')} - AI quality may be reduced`);
    }

    // Build AI prompt for vulnerability analysis
    const prompt = buildVulnerabilityPrompt(workflowData, components);

    console.log('üéØ Sending to AI with 3-tier fallback for vulnerability analysis...');

    // üîÑ Call AI with 3-tier fallback (OpenRouter ‚Üí Anthropic ‚Üí Graceful fail)
    const aiResult = await executeAIWithFallback({
      prompt,
      model: 'anthropic/claude-sonnet-4.5',
      maxTokens: 4000 // Comprehensive vulnerability analysis needs more tokens
    });

    if (!aiResult.success) {
      console.error('All AI tiers failed:', aiResult.error);
      await logDevIssue({
        type: 'api_error',
        severity: 'critical',
        component: 'vulnerability_alerts_api',
        message: 'AI vulnerability analysis failed for all tiers',
        data: {
          error: aiResult.error,
          company: workflowData.company?.name,
          componentCount: components.length,
          hsCodesCount: components.filter(c => c.hs_code || c.classified_hs_code).length
        }
      });
      throw new Error(aiResult.error);
    }

    console.log(`üîÆ AI Response from ${aiResult.provider} (Tier ${aiResult.tier}) - ${aiResult.duration}ms`);

    // Parse AI response with robust error handling
    let analysis;
    try {
      analysis = parseAIResponse(aiResult.content);

      if (analysis.parseError) {
        await logDevIssue({
          type: 'api_error',
          severity: 'high',
          component: 'vulnerability_alerts_api',
          message: 'AI vulnerability response parsing failed',
          data: {
            company: workflowData.company?.name,
            responsePreview: aiResult.content?.substring(0, 200)
          }
        });
        throw new Error('Failed to parse AI response');
      }
    } catch (parseError) {
      console.error('‚ùå Failed to parse AI response:', parseError);
      await DevIssue.apiError('vulnerability_alerts_api', '/api/ai-vulnerability-alerts (parsing)', parseError, {
        company: workflowData.company?.name,
        componentCount: components.length
      });
      throw new Error(`AI response parsing failed: ${parseError.message}`);
    }

    console.log('‚úÖ Vulnerability analysis complete:', {
      alert_count: analysis.alerts?.length,
      risk_level: analysis.overall_risk_level
    });

    // Format response
    const result = {
      success: true,
      timestamp: new Date().toISOString(),
      method: 'ai_vulnerability_analysis',

      company_context: {
        name: workflowData.company?.name || workflowData.company?.company_name,
        product: workflowData.product?.description || workflowData.product?.product_description,
        business_type: workflowData.company?.business_type,
        usmca_qualified: workflowData.usmca?.qualified
      },

      vulnerability_analysis: {
        overall_risk_level: analysis.overall_risk_level || 'MODERATE',
        risk_score: analysis.risk_score || 50,
        primary_vulnerabilities: analysis.primary_vulnerabilities || [],
        component_risks: analysis.component_risks || []
      },

      alerts: analysis.alerts || [],

      recommendations: {
        immediate_actions: analysis.recommendations?.immediate_actions || [],
        monitoring_priorities: analysis.recommendations?.monitoring_priorities || [],
        diversification_strategies: analysis.recommendations?.diversification_strategies || []
      },

      alert_subscriptions: analysis.alert_subscriptions || [],

      trust: {
        ai_powered: true,
        model: 'anthropic/claude-sonnet-4.5',
        confidence_score: analysis.confidence_score || 85,
        analysis_date: new Date().toISOString()
      }
    };

    logInfo('AI vulnerability analysis completed', {
      company: workflowData.company?.name,
      alerts_generated: result.alerts.length,
      risk_level: result.vulnerability_analysis.overall_risk_level
    });

    // Save to database if user is authenticated
    const cookies = parse(req.headers.cookie || '');
    const sessionCookie = cookies.triangle_session;
    const session = verifySession(sessionCookie);

    if (session && session.userId) {
      try {
        // Parse trade volume - handle string with commas like "12,000,000"
        const rawTradeVolume = workflowData.company?.trade_volume;
        if (!rawTradeVolume) {
          console.warn('‚ö†Ô∏è [FORM SCHEMA] Missing company.trade_volume in ai-vulnerability-alerts, skipping database save');
          return res.status(200).json(result);
        }
        const parsedTradeVolume = typeof rawTradeVolume === 'string'
          ? parseFloat(rawTradeVolume.replace(/,/g, ''))
          : rawTradeVolume;

        const { data: savedAnalysis, error: saveError } = await supabase
          .from('vulnerability_analyses')
          .insert({
            user_id: session.userId,
            company_name: result.company_context.name,
            product_description: result.company_context.product,
            business_type: result.company_context.business_type,
            hs_code: workflowData.product?.hs_code,
            trade_volume: parsedTradeVolume,
            qualification_status: workflowData.usmca?.qualified ? 'QUALIFIED' : 'NOT_QUALIFIED',
            overall_risk_level: result.vulnerability_analysis.overall_risk_level,
            risk_score: result.vulnerability_analysis.risk_score,
            alert_count: result.alerts.length,
            component_origins: components,
            primary_vulnerabilities: result.vulnerability_analysis.primary_vulnerabilities,
            component_risks: result.vulnerability_analysis.component_risks,
            alerts: result.alerts,
            recommendations: result.recommendations,
            ai_model: result.trust.model,
            confidence_score: result.trust.confidence_score
          })
          .select()
          .single();

        if (saveError) {
          console.error('‚ö†Ô∏è Failed to save vulnerability analysis:', saveError);
          await logDevIssue({
            type: 'api_error',
            severity: 'high',
            component: 'vulnerability_alerts_api',
            message: 'Failed to save vulnerability analysis to database',
            data: {
              error: saveError.message,
              userId: session.userId,
              company: result.company_context.name,
              alertCount: result.alerts.length
            }
          });
        } else {
          console.log('‚úÖ Vulnerability analysis saved to database:', savedAnalysis.id);
          result.saved_to_database = true;
          result.analysis_id = savedAnalysis.id;
        }
      } catch (dbError) {
        console.error('‚ö†Ô∏è Database save error:', dbError);
      }
    } else {
      console.log('‚ÑπÔ∏è Analysis not saved - user not authenticated');
    }

    return res.status(200).json(result);

  } catch (error) {
    logError('AI vulnerability analysis failed', {
      error: error.message,
      stack: error.stack
    });
    await DevIssue.apiError('vulnerability_alerts_api', '/api/ai-vulnerability-alerts', error, {
      hasWorkflowData: !!req.body,
      hasComponents: !!(req.body?.component_origins || req.body?.components),
      company: req.body?.company?.name || 'unknown'
    });

    return res.status(500).json({
      success: false,
      error: 'Vulnerability analysis failed',
      message: error.message,
      timestamp: new Date().toISOString()
    });
  }
}

/**
 * Build comprehensive vulnerability analysis prompt
 */
function buildVulnerabilityPrompt(workflowData, components) {
  // Format component breakdown with HS codes, tariff rates, and AI confidence
  const componentBreakdown = components
    .map((c, i) => {
      const country = c.origin_country || c.country;
      const percentage = c.value_percentage || c.percentage || 0;
      const description = c.description || 'Component';
      const hsCode = c.hs_code || c.classified_hs_code || 'Not classified';
      const mfnRate = c.mfn_rate || c.tariff_rates?.mfn_rate || 0;
      const usmcaRate = c.usmca_rate || c.tariff_rates?.usmca_rate || 0;
      const confidence = c.confidence || 'Unknown';
      const isUSMCA = c.is_usmca_member !== undefined ? c.is_usmca_member : 'Unknown';

      let componentLine = `${i + 1}. ${description}: ${percentage}% from ${country}`;

      // Add HS code if available
      if (hsCode !== 'Not classified') {
        componentLine += `\n   HS Code: ${hsCode}`;

        // Add tariff rates if available
        if (mfnRate !== 0 || usmcaRate !== 0) {
          const savings = mfnRate - usmcaRate;
          componentLine += `\n   MFN Tariff Rate: ${mfnRate.toFixed(1)}% | USMCA Rate: ${usmcaRate.toFixed(1)}%`;
          if (savings > 0) {
            componentLine += ` | Savings: ${savings.toFixed(1)}%`;
          }
        }

        // Add AI confidence if available
        if (confidence !== 'Unknown') {
          componentLine += `\n   AI Classification Confidence: ${confidence}%`;
        }
      }

      // Add USMCA status
      componentLine += `\n   USMCA Member: ${isUSMCA}`;

      return componentLine;
    })
    .join('\n\n');

  // Get country list for geopolitical analysis
  const countries = [...new Set(components.map(c => c.origin_country || c.country))].join(', ');

  // Parse trade volume for financial calculations
  const rawTradeVolume = workflowData.company?.annual_trade_volume || workflowData.company?.trade_volume || 0;
  const tradeVolume = typeof rawTradeVolume === 'string'
    ? parseFloat(rawTradeVolume.replace(/,/g, ''))
    : rawTradeVolume;

  const prompt = `You are a senior trade policy and geopolitical risk analyst with 20+ years of experience in international trade, supply chain risk management, and USMCA compliance. You have deep expertise in trade negotiations, tariff policy, and geopolitical risk assessment across North America, Asia, and Europe. Analyze this company's supply chain for trade vulnerabilities and generate specific, actionable alerts.

===== COMPLETE COMPANY PROFILE =====
Company: ${workflowData.company?.name || workflowData.company?.company_name || 'Not specified'}
Product: ${workflowData.product?.description || workflowData.product?.product_description || 'Not specified'}
Business Type: ${workflowData.company?.business_type || 'Not specified'}
Annual Trade Volume: $${tradeVolume ? tradeVolume.toLocaleString() : 'Not specified'}
USMCA Qualified: ${workflowData.usmca?.qualified ? 'YES' : 'NO'}
${workflowData.usmca?.qualified ? '' : `Gap to Qualification: ${workflowData.usmca?.gap || 'Unknown'}%`}
HS Code: ${workflowData.product?.hs_code || 'Not yet classified'}
Destination Market: ${workflowData.company?.destination_country || 'US'}
Supplier Country: ${workflowData.company?.supplier_country || 'Multiple'}

SUPPLY CHAIN COMPONENT ORIGINS:
${componentBreakdown}

Countries in Supply Chain: ${countries}

CURRENT TRADE ENVIRONMENT (January 2025):

CRITICAL POLICY DEVELOPMENTS:
‚ö†Ô∏è USMCA UNDER THREAT: Trump administration considering replacing USMCA with bilateral trade deals
   - Risk: Current 0% USMCA benefits could be renegotiated or eliminated
   - Timeline: Potential changes in 2025-2026
   - Impact: Companies relying on USMCA need backup plans NOW
   - Strategy: Build Mexico relationships regardless - geography and proximity remain advantages

TARIFF LANDSCAPE:
- China Section 301: 25% additional tariffs on most goods (machinery, electronics, textiles)
- EU/Germany MFN: 2-5% base tariffs BUT 25-35% manufacturing cost increases due to energy crisis
- USMCA Qualified: Currently 0% tariffs (but under renegotiation threat)
- India: 5-10% MFN rates, growing manufacturing capacity
- Vietnam: 0-6.5% MFN, popular China alternative but 6-8 week shipping
- Mexico: Currently 0% with USMCA + 2-week shipping advantage vs 6-8 weeks from Asia

GEOPOLITICAL RISKS (2025):
- US-China Trade War: Ongoing, high risk of additional tariffs or restrictions
- EU Energy Crisis: German manufacturing costs up 30%, supply reliability concerns
- USMCA Uncertainty: Potential bilateral renegotiation could change benefits
- Nearshoring Trend: Accelerating - companies moving production closer to US
- Political Instability: Watch Taiwan, Eastern Europe, Middle East supply routes

REALISTIC FINANCIAL SCENARIOS:
- China ‚Üí Mexico switch: Save 15-25% in tariffs + 60% faster delivery
- EU energy surcharges: Add 10-20% to German/EU component costs
- USMCA value (if maintained): Save 5-25% annually vs MFN rates
- Diversification cost: 10-15% investment to establish backup suppliers
- Bilateral deal uncertainty: Could eliminate current 0% USMCA benefits

MEXICO COMPETITIVE ADVANTAGES (Regardless of USMCA):
- Geography: 2-week shipping vs 6-8 weeks Asia, same-day trucking to US
- Time zones: Same business hours as US/Canada (vs 12hr difference Asia)
- Labor costs: 40-60% of US wages with skilled manufacturing workforce
- Proximity resilience: Less vulnerable to ocean shipping disruptions
- Cultural bridge: Spanish/English bilingual teams (Jorge's expertise)
- Customs expertise: Licensed broker (Cristina #4601913) ensures compliance

VULNERABILITY ANALYSIS INSTRUCTIONS:

1. **Identify Geopolitical Risks:**
   - Which countries have trade tensions (US-China, EU-Russia, etc.)
   - Which regions have political instability
   - Which dependencies create single points of failure
   - **CRITICAL**: Flag USMCA-dependent strategies and recommend Mexico backup plans

2. **Analyze Tariff Exposure:**
   - Current tariff rates for each origin country
   - Recent tariff changes or proposals
   - Industry-specific trade restrictions
   - Calculate potential dollar impacts using the Annual Trade Volume provided

3. **Generate Specific Alerts:**
   Each alert must be:
   - Specific to THIS company's actual supply chain
   - Include exact percentage from vulnerability analysis (e.g., "35% German components")
   - Reference specific components/countries from the breakdown above
   - Provide actionable monitoring guidance
   - **CRITICAL**: Include SPECIFIC dollar amounts based on the Annual Trade Volume
     Example: If 35% of $12M trade volume uses German components, potential exposure = $4.2M
   - Use realistic tariff scenarios (e.g., 10-25% tariff increase would cost $420k-$1.05M annually)

   **NEW ALERT TYPES TO GENERATE:**

   a) **Component-Specific Tariff Risk Alerts:**
      - Reference exact HS codes from component data (e.g., "HS 3824.90.00")
      - Show current MFN rate vs USMCA rate with dollar impact
      - Example: "Component 2: Specialty Additives (HS 3824.90.00) from India has MFN rate 8.5% vs USMCA 0%.
        Your 30% component value = $3.6M exposure. Potential tariff increase to 15% = $540K annual cost."

   b) **HS Code Confidence Warnings:**
      - Flag any component with AI confidence < 80%
      - Warn about reclassification risk and recommend professional validation
      - Example: "Component 2 classified as HS 3824.90.00 with only 65% confidence.
        Risk: Customs may reclassify, affecting tariff rates. Recommend professional HS classification review."

   c) **RVC Optimization Opportunities:**
      - If company is QUALIFIED but close to threshold, flag optimization potential
      - Calculate RVC improvement by replacing non-USMCA components
      - Example: "Currently 70% RVC (threshold 60%). Replacing 30% Indian components with Mexico suppliers
        would increase RVC to 85%, creating 15% safety margin and eliminating $540K tariff exposure."

   d) **Tariff Rate Change Monitoring:**
      - For components with high MFN rates, create monitoring alerts
      - Example: "Component 3 (HS 3206.49.60) has 15% MFN rate. Monitor for potential increases to 20-25%
        which would add $540K-$900K annual cost on your $3.6M component value."

4. **Risk Prioritization:**
   - HIGH: Immediate threat (tariff increases, sanctions, supply disruptions)
   - MEDIUM: Emerging concern (policy proposals, trade negotiations)
   - LOW: Long-term monitoring (political shifts, economic trends)

5. **Recommend Alert Subscriptions:**
   - What specific topics should this company monitor?
   - What trigger events should generate notifications?
   - What data sources are most relevant?

REQUIRED OUTPUT FORMAT (JSON):

{
  "overall_risk_level": "HIGH" | "MODERATE" | "LOW",
  "risk_score": 0-100,
  "primary_vulnerabilities": [
    {
      "vulnerability_type": "geopolitical" | "tariff" | "supply_chain",
      "description": "Specific vulnerability description",
      "affected_components": ["component names"],
      "risk_level": "HIGH" | "MEDIUM" | "LOW",
      "financial_exposure": "percentage or dollar amount"
    }
  ],
  "component_risks": [
    {
      "component": "component description",
      "origin_country": "country code",
      "percentage": number,
      "risk_factors": ["factor 1", "factor 2"],
      "risk_level": "HIGH" | "MEDIUM" | "LOW"
    }
  ],
  "alerts": [
    {
      "alert_id": "unique_id",
      "title": "Alert title specific to this company",
      "severity": "HIGH" | "MEDIUM" | "LOW",
      "category": "tariff" | "geopolitical" | "regulatory" | "supply_chain" | "confidence_warning" | "rvc_optimization",
      "description": "Detailed alert description referencing exact percentages and components",
      "affected_components": ["specific components"],
      "affected_hs_codes": ["HS codes for affected components"],
      "origin_countries": ["country codes"],
      "tariff_exposure": {
        "mfn_rate": number,
        "usmca_rate": number,
        "savings_potential": number,
        "annual_dollar_impact": number
      },
      "ai_confidence": number (optional, for confidence warnings),
      "rvc_details": {
        "current_rvc": number,
        "threshold": number,
        "potential_rvc": number,
        "safety_margin": number
      } (optional, for RVC optimization alerts),
      "potential_impact": "Specific dollar amount or percentage impact",
      "recommended_action": "What should company do about this?",
      "monitoring_guidance": "What to watch for?",
      "alert_triggers": ["What events should trigger notifications?"]
    }
  ],
  "recommendations": {
    "immediate_actions": ["Action 1 with specific details", "Action 2..."],
    "monitoring_priorities": ["What to monitor daily/weekly/monthly"],
    "diversification_strategies": ["Specific sourcing alternatives with countries"],
    "professional_services": [
      {
        "service_name": "Supplier Sourcing" | "Manufacturing Feasibility" | "Market Entry Strategy" | "USMCA Certificate" | "HS Classification" | "Crisis Response",
        "why_recommended": "Specific reason based on their supply chain",
        "expected_outcome": "What they'll achieve",
        "urgency": "HIGH" | "MEDIUM" | "LOW"
      }
    ]
  },
  "alert_subscriptions": [
    {
      "topic": "US-China trade policy",
      "relevance": "Your 45% Taiwan dependency",
      "notification_triggers": ["New tariff announcements", "Policy changes"],
      "recommended_frequency": "daily" | "weekly" | "monthly"
    }
  ],
  "confidence_score": 85
}

CRITICAL RULES:
- Be specific - reference exact component percentages from the data (e.g., "35% from Germany")
- Be realistic - use current 2025 geopolitical and trade policy context
- Be actionable - each alert must have clear recommended actions
- Be relevant - only create alerts for actual vulnerabilities in their supply chain
- **MUST INCLUDE DOLLAR AMOUNTS**: Calculate financial impacts using the Annual Trade Volume
  Formula: (Component % √ó Trade Volume) √ó Tariff Rate = Dollar Impact
  Example: (35% of $12,000,000) √ó 15% tariff = $630,000 annual increase
- Use realistic tariff scenarios: 10-25% for trade tensions, 0-5% for minor adjustments
- Reference specific components from the breakdown (not generic statements)

SERVICE RECOMMENDATION GUIDANCE:
When recommending professional services, prioritize MEXICO-based solutions:

**CRITICAL 2025 CONTEXT - USMCA Under Threat:**
Given Trump administration's consideration of bilateral deals instead of USMCA, emphasize that Mexico advantages extend BEYOND just USMCA benefits:

**For NOT QUALIFIED companies or supply chain risks:**
- "Supplier Sourcing" ‚Üí Find Mexico suppliers for proximity + cost advantages (USMCA or not)
  * Why now: Even without USMCA, Mexico beats Asia on shipping time (2 weeks vs 8 weeks)
  * Urgency: HIGH - Build relationships before bilateral deal changes

- "Manufacturing Feasibility" ‚Üí Evaluate Mexico production for nearshoring resilience
  * Why now: Geography matters regardless of tariff agreements
  * Urgency: HIGH - Prepare for potential USMCA changes

- "Market Entry Strategy" ‚Üí Expand into Mexico/Latin America markets
  * Why now: Diversify beyond US market exposure
  * Urgency: MEDIUM - Long-term strategic positioning

**For compliance/crisis issues:**
- "USMCA Certificate" ‚Üí Professional certification while USMCA still exists
  * Why now: Lock in current 0% benefits, prepare for bilateral scenario
  * Urgency: HIGH - Uncertainty makes this time-sensitive

- "HS Classification" ‚Üí Expert validation for any trade agreement scenario
  * Why now: Correct classification needed for USMCA, bilateral, or MFN rates
  * Urgency: MEDIUM - Foundation for any tariff scenario

- "Crisis Response" ‚Üí Navigate USMCA renegotiation and policy changes
  * Why now: Companies need expert guidance through trade uncertainty
  * Urgency: HIGH - Policy changes happening in 2025-2026

**Emphasize Mexico advantages (USMCA-independent):**
‚úì Geography: 2-week shipping vs 6-8 weeks Asia (saves inventory costs)
‚úì Time zones: Same-day communication vs 12hr delay with Asia
‚úì Trucking: Direct to US vs ocean freight uncertainty
‚úì Cultural fit: Jorge's bilingual team bridges business practices
‚úì Compliance: Cristina's professional certification (#4601913) ensures smooth customs
‚úì Resilience: Less vulnerable to ocean shipping disruptions (Suez, Panama Canal, etc.)
‚úì Labor costs: 40-60% of US wages with skilled workforce

**KEY MESSAGE:** Mexico makes sense with OR without USMCA - but act now before bilateral changes

Perform the vulnerability analysis now:`;

  return prompt;
}
