/**
 * Admin Sales Dashboard API
 * Returns sales funnel metrics, user conversion data, and activity stats
 * Restricted to admin users only
 */

import { createClient } from '@supabase/supabase-js';

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL,
  process.env.SUPABASE_SERVICE_ROLE_KEY
);

export default async function handler(req, res) {
  if (req.method !== 'GET') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  try {
    // Verify admin access
    const authHeader = req.headers.authorization;
    if (!authHeader) {
      return res.status(401).json({ error: 'Unauthorized - No token provided' });
    }

    const token = authHeader.replace('Bearer ', '');
    const { data: { user }, error: authError } = await supabase.auth.getUser(token);

    if (authError || !user) {
      return res.status(401).json({ error: 'Unauthorized - Invalid token' });
    }

    // Check if user is admin
    const { data: profile } = await supabase
      .from('user_profiles')
      .select('is_admin')
      .eq('user_id', user.id)
      .single();

    if (!profile?.is_admin) {
      return res.status(403).json({ error: 'Forbidden - Admin access required' });
    }

    // Fetch sales funnel data
    const { data: prospects, error: prospectsError } = await supabase
      .from('sales_prospects')
      .select('*')
      .order('created_at', { ascending: false });

    if (prospectsError) throw prospectsError;

    // Fetch user conversion data
    const { data: users, error: usersError } = await supabase
      .from('user_profiles')
      .select(`
        id,
        full_name,
        email,
        company_name,
        subscription_tier,
        status,
        trial_ends_at,
        created_at,
        analyses_this_month,
        workflow_completions,
        certificates_generated,
        total_savings
      `)
      .order('created_at', { ascending: false });

    if (usersError) throw usersError;

    // Fetch recent activity
    const { data: recentWorkflows, error: workflowsError } = await supabase
      .from('workflow_completions')
      .select(`
        id,
        company_name,
        qualification_status,
        estimated_annual_savings,
        completed_at,
        user_id
      `)
      .order('completed_at', { ascending: false })
      .limit(50);

    if (workflowsError) throw workflowsError;

    // Calculate funnel metrics
    const funnelMetrics = {
      initial_contact: prospects.filter(p => p.stage === 'initial_contact').length,
      demo_scheduled: prospects.filter(p => p.stage === 'demo_scheduled').length,
      demo_completed: prospects.filter(p => p.stage === 'demo_completed').length,
      trial_active: prospects.filter(p => p.stage === 'trial_active').length,
      negotiating: prospects.filter(p => p.stage === 'negotiating').length,
      won: prospects.filter(p => p.stage === 'won').length,
      lost: prospects.filter(p => p.stage === 'lost').length,
    };

    // Calculate user metrics
    const userMetrics = {
      total: users.length,
      trial: users.filter(u => u.subscription_tier === 'Trial').length,
      starter: users.filter(u => u.subscription_tier === 'Starter').length,
      professional: users.filter(u => u.subscription_tier === 'Professional').length,
      premium: users.filter(u => u.subscription_tier === 'Premium').length,
      active: users.filter(u => u.status === 'active').length,
      trial_expired: users.filter(u => u.status === 'trial_expired').length,
    };

    // Calculate revenue metrics (rough estimates)
    const revenueMetrics = {
      mrr: (
        users.filter(u => u.subscription_tier === 'Starter').length * 99 +
        users.filter(u => u.subscription_tier === 'Professional').length * 299 +
        users.filter(u => u.subscription_tier === 'Premium').length * 799
      ),
      arr: (
        users.filter(u => u.subscription_tier === 'Starter').length * 99 * 12 +
        users.filter(u => u.subscription_tier === 'Professional').length * 299 * 12 +
        users.filter(u => u.subscription_tier === 'Premium').length * 799 * 12
      ),
    };

    // Calculate activity metrics
    const today = new Date();
    const thirtyDaysAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
    const sevenDaysAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);

    const activityMetrics = {
      workflows_30d: recentWorkflows.filter(w =>
        new Date(w.completed_at) >= thirtyDaysAgo
      ).length,
      workflows_7d: recentWorkflows.filter(w =>
        new Date(w.completed_at) >= sevenDaysAgo
      ).length,
      qualified_30d: recentWorkflows.filter(w =>
        new Date(w.completed_at) >= thirtyDaysAgo &&
        w.qualification_status === 'QUALIFIED'
      ).length,
      total_savings_30d: recentWorkflows
        .filter(w => new Date(w.completed_at) >= thirtyDaysAgo)
        .reduce((sum, w) => sum + (parseFloat(w.estimated_annual_savings) || 0), 0),
    };

    // Return comprehensive dashboard data
    return res.status(200).json({
      success: true,
      data: {
        funnel: funnelMetrics,
        users: userMetrics,
        revenue: revenueMetrics,
        activity: activityMetrics,
        prospects: prospects.slice(0, 20), // Recent 20 prospects
        recentUsers: users.slice(0, 20), // Recent 20 users
        recentWorkflows: recentWorkflows.slice(0, 20), // Recent 20 workflows
      },
      generated_at: new Date().toISOString(),
    });

  } catch (error) {
    console.error('Admin sales data error:', error);
    return res.status(500).json({
      error: 'Internal server error',
      message: error.message
    });
  }
}
